<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2020 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2020.css" type="text/css" />
    <title>
Perl Advent Calendar 2020 - 
Tie::File

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2020</a></h1>
        </div>

        <p id="tagline">2020 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Tie::File</h1>
<div class='subtitle'>Tie::File - 2020-12-14</div>

<div class='pod'><p><div class="bestof"> 2020 has been time consuming - a global pandemic, giant fires, horrific floods and political unrest - which has left us little time for side projects. This year we're looking back to happier times into the 20+ year archive with the Best of the Perl Advent Calendar. </div>

</p>



<p>Have you ever wanted to use Perl to change a line in the middle of a data file? While this may sound like a trivial thing for a human to do (or for a text editor) it&#39;s actually quite hard to do programattically.</p>

<p>While you and I think of a text file as many separate lines of data, as far as the computer is concerned the file is just a big collection of characters, one after the other. Perl can read in lines at a time by scanning for the special delimiting return characters, but changing it another story - one that involves much copying of data to make space for the data you&#39;re adding in or to remove the space the data you took out was taking up.</p>

<p>What we need is a module that takes away the pain of dealing with a file and understands that if we want to insert a line, then it should silently do all the copying and manipulating and all the other complex stuff we don&#39;t want to think of ourselves for us.</p>

<p>This is where <b>Tie::File</b> is useful. It lets us treat a file just as if it was a big array of lines that we can manipulate at will. Suddenly, editing files becomes trivial and we don&#39;t have to worry about all the things that suddenly seemed so hard before. Isn&#39;t this what Perl modules are all about?</p>

<p><b>Tie::File</b> uses Perl&#39;s tie interface. This means that we &#39;tie&#39; an object to a data structure - in this case an array. Every time we do something to the array rather than manipulating a real array it calls methods on the object. In the case of <b>Tie::File</b> this object manipulates the underlying file that we&#39;re editing.</p>

<p>Each entry in the array represents a single line of the file, so removing or adding lines removes or adds lines to the file, and changing lines changes the corresponding line in the file.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="comment"># turn on Perl's safety features<br /></span><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><span class="readline">&lt;/pre&gt;</span><br /><br /><span class="comment"># tie the file 'file' to the array '@file'.  From this point<br /># on the lines of 'file' are the entries in @file and vice versa<br /></span><span class="word">use</span> <span class="word">Tie::File</span><span class="structure">;</span><br /><span class="word">tie</span> <span class="word">my</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="double">&quot;Tie::File&quot;</span><span class="operator">,</span> <span class="double">&quot;file&quot;</span><span class="structure">;</span><br /><br /><span class="comment"># add a line to the end of the file<br /></span><span class="word">push</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="double">&quot;Program starting at: &quot;</span><span class="operator">.</span><span class="word">time</span></code><br />&nbsp;</td></table>

<p>Note how we don&#39;t bother ending the string we&#39;re pushing onto the array with a new line character - there&#39;s no need, each line is a new line in itself. However having said that, ending the line with a &#39;superfluous&#39; newline is also perfectly acceptable - it&#39;ll just be silently removed. So:&gt;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># add a line to the end of the file<br /></span><span class="word">push</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="double">&quot;Program starting at: &quot;</span><span class="operator">.</span> <span class="word">time</span> <span class="operator">.</span> <span class="double">&quot;\n&quot;</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Would have be equally okay. We can also read in lines as you might expect:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">print</span> <span class="double">&quot;The last line of the file is: $file[-1]\n&quot;</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>While adding a line to the end of a file isn&#39;t that complicated consider adding data to the start of a file. With &lt;b&gt;Tie::File&lt;/b&gt; it&#39;s this simple:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># add a line to the start of the file<br /></span><span class="word">unshift</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="double">&quot;Program Log&quot;</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>This is a much harder operation to code in straight Perl. If you want to add data to the start of the file the simplest way to do this is to create a new file, write the line to it, copy the whole contents of the old file onto the end of the new file, then rename it to be the same name as the original file. The code to do that is:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">IO::AtomicFile</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">IO::File</span><span class="structure">;</span><span class="readline">&lt;/pre&gt;</span><br /><br /><span class="comment"># open the files one for reading and one for writing<br /></span><span class="word">my</span> <span class="symbol">$original</span> <span class="operator">=</span> <span class="word">IO::File</span><span class="operator">-&gt;</span><span class="structure">;</span><span class="word">new</span><span class="structure">(</span><span class="double">&quot;file&quot;</span><span class="structure">)</span><br />&nbsp;&nbsp;<span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;Can't write to 'file': $!&quot;</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$changed</span>  <span class="operator">=</span> <span class="word">IO::AtomicFile</span><span class="operator">-&gt;</span><span class="structure">;</span><span class="word">new</span><span class="structure">(</span><span class="double">&quot;file&quot;</span><span class="operator">,</span><span class="double">&quot;&gt;&quot;</span><span class="structure">)</span><br />&nbsp;&nbsp;<span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;Can't write to 'file.TMP': $!&quot;</span><span class="structure">;</span><br /><br /><span class="comment"># add the line<br /></span><span class="word">print</span> <span class="structure">{</span><span class="symbol">$changed</span><span class="structure">}</span> <span class="double">&quot;Program Log\n&quot;</span><span class="structure">;</span><br /><br /><span class="comment"># copy the rest of the data<br /></span><span class="word">print</span> <span class="structure">{</span><span class="symbol">$changed</span><span class="structure">}</span> <span class="magic">$_</span> <span class="word">while</span> <span class="structure">(</span><span class="symbol">&amp;lt</span><span class="structure">;</span><span class="symbol">$original&amp;gt</span><span class="structure">;);</span></code><br />&nbsp;</td></table>

<p>And that&#39;s with <b>IO::AtomicFile</b> doing the renaming of the file when we&#39;re done writing it for us! You can can see how much easier <b>Tie::File</b> is making our life already. Changing lines in the middle of files can be even more problematic, however with <b>Tie::File</b> we can simply rewrite individual lines by changing the contents of the array for that line:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># change the 13th line to say it's unlucky<br /></span><span class="symbol">$file</span><span class="structure">[</span><span class="number">12</span><span class="structure">]</span> <span class="operator">=</span> <span class="double">&quot;I'm unlucky, oh woe is me&quot;</span><span class="structure">;</span><br /><br /><span class="comment"># change every mention of Christmas to Xmas in the 10th line<br /></span><span class="symbol">$file</span><span class="structure">[</span><span class="number">9</span><span class="structure">]</span> <span class="operator">=~</span> <span class="substitute">s/Christmas/Xmas/gi</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>In the last line of the above example we see a substitution showing that we can read data in and write new data out and <b>Tie::File</b> deals with all the complexities for us. Even better that this, we can make use of some little known but very useful feature of Perl&#39;s <code>foreach</code> loop to do the same kind of substitution over the entire file:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># run over '@file' making '$line' the current line each loop<br /></span><span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$line</span> <span class="structure">(</span><span class="symbol">@file</span><span class="structure">)</span><br /><span class="structure">{</span><br />&nbsp;&nbsp;<span class="word">print</span> <span class="double">&quot;Old line was: $line\n&quot;</span><span class="structure">;</span><br />&nbsp;<br /><span class="comment">  # change the line<br /></span>  <span class="symbol">$line</span> <span class="operator">=~</span> <span class="substitute">s/Christmas/Xmas/gi</span><span class="structure">;</span><span class="readline">&lt;/pre&gt;</span><br /><br />&nbsp;&nbsp;<span class="word">print</span> <span class="double">&quot;New line is: $line\n&quot;</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Because <code>$line</code> isn&#39;t assigned the value of the element of <code>@file</code> we&#39;re dealing with - it <i>is</i> the line - it&#39;s an <i>implicit alias</i>, changing <code>$line</code> will actually change the original element in <code>@file</code> which in reality will change the line in the file.</p>

<p>Adding lines and deleting lines in the middle of the file with <b>Tie::File</b> is a little harder than simply editing them - mostly because we get to use the oft misunderstood <code>splice</code> operator on the array (though it&#39;s a lot easier than trying to read it in and write it out again.) To remove lines with splice we simply need to state the array, the index of what we want to remove and how many lines we want to remove.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># remove the 10th line from the file<br /></span><span class="word">splice</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="number">9</span><span class="operator">,</span> <span class="number">1</span><span class="structure">;</span><br /><br /><span class="comment"># remove the 12th, 13th and 14th line from the file<br /></span><span class="word">splice</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="number">11</span><span class="operator">,</span> <span class="number">3</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>To replace lines from the file we simply add in replacement lines at the end of the splice operation.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># remove the 12th, 13th and 13th line from the file<br /># and replace the three of them with two new lines<br /></span><span class="word">splice</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="number">11</span><span class="operator">,</span> <span class="number">3</span><span class="operator">,</span> <span class="double">&quot;First Replacement Line&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Second Replacement Line&quot;</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>To just insert lines instead of replacing them all we need to do is set the third argument to <code>splice</code> - the number of lines to be removed - to zero.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># insert two lines after the 11th line before the 12th<br /></span><span class="word">splice</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="number">11</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="double">&quot;First Replacement Line&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Second Replacement Line&quot;</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<h3 id="Under-The-Hood">Under The Hood</h3>

<p>Of course, <b>Tie::File</b> actually has to manipulate the file itself somewhat like we described in the long winded example above. In order to do this with some semblance of efficiency it will attempt to cache a little (but not too much) of the file in memory. You can control how much memory it will use when you tie the file:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># use lots and lots of memory<br /></span><span class="word">tie</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="single">'Tie::File'</span><span class="operator">,</span> <span class="symbol">$file</span><span class="operator">,</span> <span class="word">memory</span> <span class="operator">=&gt;</span> <span class="number">20_000_000</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>One trick that you might want to employ if you&#39;ve got multiple programs running at the same time is to turn off all this caching. This will cause the program to read the file every time you read from the array - vital if another program may have written to it and cached data might be wrong by now.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># don't cache - other programs may be writing to <br /># the file so our cached data might be wrong!<br /></span><span class="word">tie</span> <span class="symbol">@file</span><span class="operator">,</span> <span class="single">'Tie::File'</span><span class="operator">,</span> <span class="symbol">$file</span><span class="operator">,</span> <span class="word">memory</span> <span class="operator">=&gt;</span> <span class="number">0</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>If you&#39;re interested in having multiple files access the file you should take a look at <b>Tie::File</b>&#39;s <code>flock</code> method.</p>

<p>There&#39;s lots of other good features that <b>Tie::File</b> offers. One wonderful feature is deferred writing, where changes aren&#39;t written to disk immediately. This is useful if you&#39;re editing the same parts of the file over and over (so the changes only have to be written once) but of course raises issues like what happens if your program crashes before the write cache is flushed. More details on this and other features are in the wonderful manual page.</p>

<p><ul> <li><a href="https://metacpan.org/pod/Tie::File">Tie::File</a></li> <li><a href="http://perl.plover.com/yak/tiefile/">MJD's Tie::File Talk Slides</a></li> <li><a href="http://www.perldoc.com/perl5.8.0/pod/perltie.html">perltie documentation</a></li></p> </ul>

</p>



</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Growing Christmas Trees" href="2020-12-13.html">Previous</a></li>

    <li class="next"><a title="A Christmas Memory" href="2020-12-15.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





