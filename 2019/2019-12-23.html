<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Testing our Impatience

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Testing our Impatience</h1>
<div class='subtitle'>App::yath - 2019-12-23</div>

<div class='pod'><p>&quot;I can make your tests take half the time&quot;, was the claim that Garland Snowboughs had made.</p>

<p>Twice as fast? Rustic Mullingfig had hardly started building out the implementation of his Christmas Tree class. It wasn&#39;t possible that he&#39;d made the code go slow yet - there really wasn&#39;t much of it.</p>

<p>&quot;Go on then mate, I&#39;ll bet you a mince pie that you can&#39;t manage it.&quot;</p>

<p>The bet was on.</p>

<h3 id="The-Tests-in-Question">The Tests in Question</h3>

<p>There really wasn&#39;t much to the code yet. So far Rustic had only implemented the planted attribute (that defaulted to the time the object was created) and some stringification.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">XmasTree</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">DateTime</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'planted'</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span> <span class="structure">}</span><br /><span class="structure">);</span><br /><br /><span class="keyword">use</span> <span class="pragma">overload</span> <span class="single">'&quot;&quot;'</span> <span class="operator">=&gt;</span> <span class="single">'as_string'</span><span class="structure">;</span><br /><span class="keyword">sub</span> <span class="word">as_string</span> <span class="prototype">($self)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="double">&quot;A Xmas Tree, planted on @{[ $self-&gt;planted ]}&quot;</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>And he&#39;d written two basic tests - one for the stringification:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">XmasTree</span><span class="structure">;</span><br /><br /><span class="comment"># look, a year 2020 bug!<br /></span><span class="word">like</span><span class="structure">(</span> <span class="word">XmasTree</span><span class="operator">-&gt;</span><span class="word">new</span><span class="operator">,</span> <span class="regexp">qr/An Xmas Tree, planted on 2019/</span> <span class="structure">);</span><br /><br /><span class="word">done_testing</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>And one for the planted attribute itself:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">XmasTree</span><span class="structure">;</span><br /><br /><span class="word">is</span><span class="structure">(</span> <span class="word">XmasTree</span><span class="operator">-&gt;</span><span class="word">new</span><span class="operator">,</span> <span class="word">object</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">call</span> <span class="word">planted</span> <span class="operator">=&gt;</span> <span class="word">object</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">prop</span> <span class="word">blessed</span> <span class="operator">=&gt;</span> <span class="single">'DateTime'</span><span class="structure">;</span><br /><br /><span class="comment">        # look, a year 2020 bug!<br /></span>        <span class="word">call</span> <span class="word">year</span> <span class="operator">=&gt;</span> <span class="number">2019</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><span class="structure">});</span><br /><span class="word">done_testing</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>These ran pretty darn quickly:</p>

<pre><code>    shell$ yath -Ilib t

    ** Defaulting to the &#39;test&#39; command **

    ( PASSED )  job  1    t/planted.t
    ( PASSED )  job  2    t/stringification.t

    ================================================================================

    Run ID: A60F80C6-251F-11EA-ADBC-83BD753448D3

    All tests were successful!


    1.17659s on wallclock (0.19 usr 0.02 sys + 0.93 cusr 0.11 csys = 1.25 CPU)</code></pre>

<p>How is Garland going to speed those tests up?</p>

<h3 id="Faster">Faster</h3>

<p>The first thing Garland changed was to add the <code>-P</code> option to <code>yath</code>.</p>

<p><code>yath</code> is the Test2 test harness (yath stands for Yet Another Test Harness.) Each test it runs forks a new process, executes the test script, and gathers the STDERR and STDOUT of the child process in the parent test harness process to work out the results.</p>

<p>The <code>-P</code> option tells the harness to load the mentioned module <i>before</i> it forks. So by specifying <code>-PDateTime</code> we only have to load DateTime once in the parent process, not twice, once in each child process as it loads</p>

<pre><code>    shell$ yath -PDateTime -PMoose  -Ilib t

    ** Defaulting to the &#39;test&#39; command **

    ( PASSED )  job  1    t/planted.t
    ( PASSED )  job  2    t/stringification.t

    ================================================================================

    Run ID: D10B83C4-251F-11EA-BDAA-9B6707E666E2

    All tests were successful!


    0.90175s on wallclock (0.19 usr 0.02 sys + 0.68 cusr 0.10 csys = 0.99 CPU)</code></pre>

<p>Whoo! That only took 77% of the time it previously did...but Garland had promised more! Can we make it faster still?</p>

<h3 id="Faster-Still">Faster Still</h3>

<p>The key realization is that not only that DateTime and other CPAN modules we use do not change between the different test scripts we execute, they don&#39;t change between different <i>runs of the same test script</i>. Or, to put it another way...we want to load them into memory once and then every time after (until we eventually upgrade our Perl modules) we won&#39;t have to run them again.</p>

<p>To do this <code>yath</code> has a <i>daemon</i> mode. You can start it up by using the <code>start</code> command:</p>

<pre><code>    shell$ yath start -PDateTime -PMoose
    Waiting for runner...

    Persistent runner started!
    Runner PID: 3199
    Runner dir: /tmp/yath-test-3198-JClS5vpt
    Runner logs:
    standard output: /tmp/yath-test-3198-JClS5vpt/output.log
    standard  error: /tmp/yath-test-3198-JClS5vpt/error.log

    Use `yath watch` to monitor the persistent runner

    0.58685s on wallclock (0.19 usr 0.02 sys + 0.00 cusr 0.00 csys = 0.21 CPU)</code></pre>

<p>Now whenever we run yath from this directory it&#39;ll contact this daemon and have <i>it</i> run the tests instead - and its already loaded the modules!</p>

<pre><code>    shell$ yath t

    ** Persistent runner detected, defaulting to the &#39;run&#39; command **

    ( PASSED )  job 3485-1    t/planted.t
    ( PASSED )  job 3485-2    t/stringification.t

    ================================================================================

    Run ID: D682502A-2520-11EA-8563-D1A3990446BB

    All tests were successful!


    0.35264s on wallclock (0.18 usr 0.03 sys + 0.00 cusr 0.00 csys = 0.21 CPU)</code></pre>

<p>Okay, that took less than 30% of the original time it took - over three times as fast!</p>

<p>Of course, this speed up will become more significant the more stable unchanging CPAN modules we pull in as our codebase becomes bigger.</p>

<p>We can even make this easier by having a <i>preload</i> module that we use whenever we get ready to start testing.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">reloadStandard</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moose</span> <span class="structure">();</span><br /><span class="keyword">use</span> <span class="word">DateTime</span> <span class="structure">();</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>And then</p>

<pre><code>    shell$ yath start -PreloadStandard
    ...</code></pre>

<p>But more importantly, what this means is that Garland is owed some mince pies!</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Comparing More" href="2019-12-22.html">Previous</a></li>

    <li class="next"><a title="We Wish You a Meme Christmas" href="2019-12-24.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





