<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Now With Added Interactivity

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Now With Added Interactivity</h1>
<div class='subtitle'>Mojo::Transaction::Websocket - 2019-12-11</div>

<div class='pod'><p>The Wise Old Elf had locked himself in his office for several days. The other elves were starting to get worried.</p>

<p>It had all started after helping Buster Stripytights with a <a href="http://perladvent.org/2019/2019-12-09.html">command line script that launched a browser based web app</a>. Then one of the elves had heard him muttering about something that Fir Cidergift had been working on to use Mojo::AsyncAwait to <a href="http://perladvent.org/2019/2019-12-10.html">handle awating like JavaScript does</a>. Apparently something about these two ideas had inspired the elf into a deep coding session.</p>

<p>The furious typing noises emanating from behind the door stopped. Suddenly The Wise Old Elf burst out of his office waving his arms.</p>

<p>&quot;Eureka! Eureka!&quot; he shouted (which as we all know is elf for &quot;this bath water is too hot&quot;) &quot;Just take a look at this&quot;.</p>

<p>Crowding around the elves watched the Wise Old Elf type at the terminal:</p>

<pre><code>   $ ./merry.pl</code></pre>

<p>No sooner had he hit return then a browser window popped up on the screen showing a dialog.</p>

<p><img src="dialog.jpg" alt="dialog with input and Ok and Cancel buttons" width="720" height="384">

</p>



<p>The wise old elf pressed a &quot;OK&quot; and back at the terminal the Perl script printed out the text from the text field.</p>

<pre><code>    $ ./merry.pl
    Merry Christmas, Wise Old Elf</code></pre>

<p>&quot;That&#39;s not the impressive bit&quot;, the Wise Old Elf explained. &quot;The impressive bit is how I got it to do that&quot;. He opened the his editor and brought up the source code.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/user/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">QuickBrowserGUI</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::AsyncAwait</span><span class="structure">;</span><br /><br /><span class="word">callback</span> <span class="single">'ok_clicked'</span> <span class="operator">=&gt;</span> <span class="word">async</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="word">await</span> <span class="word">call_javascript</span><span class="structure">(</span><span class="single">'getFormTextFieldValue'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="double">&quot;Merry Christmas, $name\n&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">await</span> <span class="word">call_javascript</span><span class="structure">(</span><span class="single">'close'</span><span class="structure">);</span><br /><span class="structure">};</span><br /><br /><span class="word">callback</span> <span class="single">'cancel_clicked'</span> <span class="operator">=&gt;</span> <span class="word">async</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">await</span> <span class="word">call_javascript</span><span class="structure">(</span><span class="single">'close'</span><span class="structure">);</span><br /><span class="structure">};</span><br /><br /><span class="word">start</span><span class="structure">();</span><br /><br /><span class="separator">__DATA__</span><br /><span class="data"><br />@@ content.html.ep<br /><br />&lt;h1&gt;Who?&lt;/h1&gt;<br /><br />&lt;div class=&quot;form-group&quot;&gt;<br />&lt;input  id='string' class=&quot;form-control&quot; value=&quot;Santa&quot;&gt;<br />&lt;/div&gt;<br /><br />&lt;div class=&quot;form-group&quot;&gt;<br />&lt;button id='ok'     class=&quot;btn btn-primary clickable&quot;&gt;OK&lt;/button&gt;<br />&lt;button id='cancel' class=&quot;btn btn-danger  clickable&quot;&gt;Cancel&lt;/button&gt;<br />&lt;/div&gt;<br /><br />&lt;script&gt;<br />function getFormTextFieldValue() {<br />&nbsp;&nbsp;&nbsp;&nbsp;return $('#string').val();<br />}<br />&lt;/script&gt;</span></code><br />&nbsp;</td></table>

<p>Perl code is being triggered from JavaScript (in this case automatically when the buttons are pressed) and we can also see the Perl code calling JavaScript code and asynchronously awaiting for the return value to be returned to it.</p>

<h3 id="Under-the-Hood">Under the Hood</h3>

<p>Under the hood the Wise Old Elf had tied Perl and JavaScript together with a websocket. He&#39;d dressed the whole thing up with a wrapper of Bootstrap to make it pretty. And he&#39;d taken advantage of the promises and await syntax to produce code that had virtually hidden the complexity of having to await for Perl and JavaScript to talk over a socket.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;<br />65:&nbsp;<br />66:&nbsp;<br />67:&nbsp;<br />68:&nbsp;<br />69:&nbsp;<br />70:&nbsp;<br />71:&nbsp;<br />72:&nbsp;<br />73:&nbsp;<br />74:&nbsp;<br />75:&nbsp;<br />76:&nbsp;<br />77:&nbsp;<br />78:&nbsp;<br />79:&nbsp;<br />80:&nbsp;<br />81:&nbsp;<br />82:&nbsp;<br />83:&nbsp;<br />84:&nbsp;<br />85:&nbsp;<br />86:&nbsp;<br />87:&nbsp;<br />88:&nbsp;<br />89:&nbsp;<br />90:&nbsp;<br />91:&nbsp;<br />92:&nbsp;<br />93:&nbsp;<br />94:&nbsp;<br />95:&nbsp;<br />96:&nbsp;<br />97:&nbsp;<br />98:&nbsp;<br />99:&nbsp;<br />100:&nbsp;<br />101:&nbsp;<br />102:&nbsp;<br />103:&nbsp;<br />104:&nbsp;<br />105:&nbsp;<br />106:&nbsp;<br />107:&nbsp;<br />108:&nbsp;<br />109:&nbsp;<br />110:&nbsp;<br />111:&nbsp;<br />112:&nbsp;<br />113:&nbsp;<br />114:&nbsp;<br />115:&nbsp;<br />116:&nbsp;<br />117:&nbsp;<br />118:&nbsp;<br />119:&nbsp;<br />120:&nbsp;<br />121:&nbsp;<br />122:&nbsp;<br />123:&nbsp;<br />124:&nbsp;<br />125:&nbsp;<br />126:&nbsp;<br />127:&nbsp;<br />128:&nbsp;<br />129:&nbsp;<br />130:&nbsp;<br />131:&nbsp;<br />132:&nbsp;<br />133:&nbsp;<br />134:&nbsp;<br />135:&nbsp;<br />136:&nbsp;<br />137:&nbsp;<br />138:&nbsp;<br />139:&nbsp;<br />140:&nbsp;<br />141:&nbsp;<br />142:&nbsp;<br />143:&nbsp;<br />144:&nbsp;<br />145:&nbsp;<br />146:&nbsp;<br />147:&nbsp;<br />148:&nbsp;<br />149:&nbsp;<br />150:&nbsp;<br />151:&nbsp;<br />152:&nbsp;<br />153:&nbsp;<br />154:&nbsp;<br />155:&nbsp;<br />156:&nbsp;<br />157:&nbsp;<br />158:&nbsp;<br />159:&nbsp;<br />160:&nbsp;<br />161:&nbsp;<br />162:&nbsp;<br />163:&nbsp;<br />164:&nbsp;<br />165:&nbsp;<br />166:&nbsp;<br />167:&nbsp;<br />168:&nbsp;<br />169:&nbsp;<br />170:&nbsp;<br />171:&nbsp;<br />172:&nbsp;<br />173:&nbsp;<br />174:&nbsp;<br />175:&nbsp;<br />176:&nbsp;<br />177:&nbsp;<br />178:&nbsp;<br />179:&nbsp;<br />180:&nbsp;<br />181:&nbsp;<br />182:&nbsp;<br />183:&nbsp;<br />184:&nbsp;<br />185:&nbsp;<br />186:&nbsp;<br />187:&nbsp;<br />188:&nbsp;<br />189:&nbsp;<br />190:&nbsp;<br />191:&nbsp;<br />192:&nbsp;<br />193:&nbsp;<br />194:&nbsp;<br />195:&nbsp;<br />196:&nbsp;<br />197:&nbsp;<br />198:&nbsp;<br />199:&nbsp;<br />200:&nbsp;<br />201:&nbsp;<br />202:&nbsp;<br />203:&nbsp;<br />204:&nbsp;<br />205:&nbsp;<br />206:&nbsp;<br />207:&nbsp;<br />208:&nbsp;<br />209:&nbsp;<br />210:&nbsp;<br />211:&nbsp;<br />212:&nbsp;<br />213:&nbsp;<br />214:&nbsp;<br />215:&nbsp;<br />216:&nbsp;<br />217:&nbsp;<br />218:&nbsp;<br />219:&nbsp;<br />220:&nbsp;<br />221:&nbsp;<br />222:&nbsp;<br />223:&nbsp;<br />224:&nbsp;<br />225:&nbsp;<br />226:&nbsp;<br />227:&nbsp;<br />228:&nbsp;<br />229:&nbsp;<br />230:&nbsp;<br />231:&nbsp;<br />232:&nbsp;<br />233:&nbsp;<br />234:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">QuickBrowserGUI</span><span class="structure">;</span><br /><br /><span class="comment"># Switch back to modifying the main package directly<br /># This is normally a really bad idea, but considering how this is<br /># meant to be used in one-off scripts and how much we'd have to<br /># export (everything) this is actually the cleanest way to do it.<br /></span><span class="keyword">package</span> <span class="word">main</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Mojolicious::Lite</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Browser::Open</span> <span class="words">qw( open_browser )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::JSON</span> <span class="words">qw( encode_json decode_json )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Net::EmptyPort</span> <span class="words">qw( empty_port )</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$port</span> <span class="operator">=</span> <span class="word">empty_port</span><span class="structure">();</span><br /><br /><span class="comment"># these are the only two HTTP routes.  All other communication occurs<br /># via the websocket<br /></span><span class="word">get</span> <span class="single">'/'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$c</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">render</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'index'</span><span class="operator">,</span><br /><br /><span class="comment">        # The address of the websocket we're going to connect on.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Use &quot;encode_json&quot; out of habit (any data you need to render<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in a JavaScript should be encoded to JSON with a &lt;script&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# safe JSON encoding library like Mojo::JSON)<br /></span>        <span class="word">websocket_address</span> <span class="operator">=&gt;</span> <span class="word">encode_json</span><span class="structure">(</span><span class="double">&quot;ws://127.0.0.1:$port/perl&quot;</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span><br /><span class="word">post</span> <span class="single">'/exit'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">exit</span> <span class="structure">};</span><br /><br /><span class="comment"># global state<br /></span><br /><span class="comment"># named code that will be executed whenever called from JavaScript<br /># via the websocket.  Can be declared as 'callback foo =&gt; sub { ... };'<br /></span><span class="keyword">my</span> <span class="symbol">%callbacks</span><span class="structure">;</span><br /><span class="keyword">sub</span> <span class="word">callback</span> <span class="prototype">($$)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$callback</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$callbacks</span><span class="structure">{</span> <span class="symbol">$name</span> <span class="structure">}</span> <span class="operator">=</span> <span class="symbol">$callback</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="comment"># on ready handlers that are called (in order) when the JavaScript<br /># document is ready and the websocket has been connected.  Can<br /># be declared as 'on_ready sub { ... };'<br /></span><span class="keyword">my</span> <span class="symbol">@on_ready</span><span class="structure">;</span><br /><span class="keyword">sub</span> <span class="word">on_ready</span><span class="prototype">(&amp;)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="symbol">@on_ready</span><span class="operator">,</span> <span class="core">shift</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="comment"># Whenever we call JavaScript from Perl we store a promise here<br /># which will be resolved once the JavaScript sends the results back<br /># down the websocket to Perl<br /></span><span class="keyword">my</span> <span class="symbol">%websocket_resolvable_promises</span><span class="structure">;</span><br /><br /><span class="comment"># this websocket is the guts of the communication between the<br /># browser and the perl code<br /></span><span class="keyword">my</span> <span class="symbol">$websocket_tx</span><span class="structure">;</span><br /><span class="word">websocket</span> <span class="single">'/perl'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br /><span class="comment">    # $websocket_tx is the transaction we can use to send data to the<br />&nbsp;&nbsp;&nbsp;&nbsp;# websocket.  Normally when writing a webserver we'd have<br />&nbsp;&nbsp;&nbsp;&nbsp;# to worry about one of these per websocket connection, but<br />&nbsp;&nbsp;&nbsp;&nbsp;# as we control both the server and client here we know for<br />&nbsp;&nbsp;&nbsp;&nbsp;# sure there's only ever one websocket connection<br /></span>    <span class="symbol">$websocket_tx</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">tx</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">on</span><span class="structure">(</span> <span class="word">message</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="core">undef</span><span class="operator">,</span> <span class="symbol">$message</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$data</span> <span class="operator">=</span> <span class="word">decode_json</span><span class="structure">(</span><span class="symbol">$message</span><span class="structure">);</span><br /><br /><span class="comment">        # TYPE 'ready'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the JS is sending a ready message meaning that we need<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to call all of the on_ready handlers in @on_ready<br /></span>        <span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">type</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'ready'</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="operator">-&gt;</span><span class="structure">()</span> <span class="word">for</span> <span class="symbol">@on_ready</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br /><span class="comment">        # TYPE 'callback'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the JS is sending a callback message (either directly because<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# someone executed 'perlCallback(&quot;name&quot;, arg, arg..)' or implicitly<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# because someone clicked on a '.clickable' button.  Note<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# that these callbacks cannot return anything to JavaScript.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# They're called in a blocking fashion so they should not block,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# but obviously they can await with async/await as normal and<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# call JavaScript functions via 'call_javascript' to pass<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# control back to the JS code.<br /></span>        <span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">type</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'callback'</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">payload</span><span class="structure">}{</span><span class="word">name</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$args</span> <span class="operator">=</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">oayload</span><span class="structure">}{</span><span class="word">args</span><span class="structure">};</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$cb</span> <span class="operator">=</span> <span class="symbol">$callbacks</span><span class="structure">{</span> <span class="symbol">$name</span> <span class="structure">}</span> <span class="operator">or</span> <span class="keyword">return</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$cb</span><span class="operator">-&gt;</span><span class="structure">(</span><span class="cast">@</span><span class="structure">{</span> <span class="symbol">$args</span> <span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br /><span class="comment">        # type 'response'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the JS is sending the result of a call from Perl to JS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this includes the id of the promise that must be resolved<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# with whatever the JavaScript function returned<br /></span>        <span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">type</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'response'</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$id</span> <span class="operator">=</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">id</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$promise_to_resolve</span> <span class="operator">=</span> <span class="symbol">$websocket_resolvable_promises</span><span class="structure">{</span> <span class="symbol">$id</span> <span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">or</span> <span class="keyword">return</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$promise_to_resolve</span><span class="operator">-&gt;</span><span class="word">resolve</span><span class="structure">(</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">payload</span><span class="structure">}</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">};</span><br /><br /><span class="comment"># this code calls the JavaScript routine on the client in an<br /># async manner via the websocket, serializing and deserializing the<br /># data you pass via JSON.<br /></span><span class="keyword">sub</span> <span class="word">call_javascript</span> <span class="prototype">($@)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@args</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br /><span class="comment">    # each call needs a unique id<br /></span>    <span class="word">state</span> <span class="symbol">$id</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$id</span><span class="operator">++</span><span class="structure">;</span><br /><br /><span class="comment">    # send the request to call the JavaScript over the websocket<br /></span>    <span class="symbol">$websocket_tx</span><span class="operator">-&gt;</span><span class="word">send</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">json</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">type</span> <span class="operator">=&gt;</span> <span class="single">'call'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">id</span> <span class="operator">=&gt;</span> <span class="symbol">$id</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">payload</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="symbol">$name</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">args</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">@args</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><br /><span class="comment">    # create a promise that our websocket handler will resolve when<br />&nbsp;&nbsp;&nbsp;&nbsp;# it gets the result from JavaScript back over the websocket<br /></span>    <span class="keyword">my</span> <span class="symbol">$promise</span> <span class="operator">=</span> <span class="word">Mojo::Promise</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$websocket_resolvable_promises</span><span class="structure">{</span> <span class="symbol">$id</span> <span class="structure">}</span> <span class="operator">=</span> <span class="symbol">$promise</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$promise</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="comment"># starting up the webserver on the correct port, opening the browser<br /># and suppressing logs.  This is the same as described in<br /># http://perladvent.org/2019/2019-12-09.html<br /></span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">log</span><span class="operator">-&gt;</span><span class="word">level</span><span class="structure">(</span><span class="single">'warn'</span><span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$base_url</span> <span class="operator">=</span> <span class="double">&quot;http://127.0.0.1:$port&quot;</span><span class="structure">;</span><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">hook</span><span class="structure">(</span><span class="word">before_server_start</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$server</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$server</span><span class="operator">-&gt;</span><span class="word">silent</span><span class="structure">(</span><span class="number">1</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">open_browser</span><span class="structure">(</span><span class="symbol">$base_url</span><span class="structure">);</span><br /><span class="structure">});</span><br /><span class="keyword">sub</span> <span class="word">start</span> <span class="structure">{</span> <span class="word">app</span><span class="operator">-&gt;</span><span class="word">start</span><span class="structure">(</span><span class="single">'daemon'</span><span class="operator">,</span><span class="single">'--listen'</span><span class="operator">,</span> <span class="symbol">$base_url</span> <span class="structure">);</span> <span class="structure">}</span><br /><br /><span class="comment"># also include these templates plus whatever is in the main script<br /></span><span class="keyword">BEGIN</span> <span class="structure">{</span> <span class="word">push</span> <span class="cast">@</span><span class="structure">{</span> <span class="word">app</span><span class="operator">-&gt;</span><span class="word">renderer</span><span class="operator">-&gt;</span><span class="word">classes</span> <span class="structure">}</span><span class="operator">,</span> <span class="single">'QuickBrowserGUI'</span> <span class="structure">};</span><br /><span class="keyword">package</span> <span class="word">QuickBrowserGUI</span><span class="structure">;</span><br /><span class="separator">__DATA__</span><br /><span class="data"><br />@@ index.html.ep<br /><br />&lt;html&gt;<br /><br />% # load jquery, bootstrap, etc.<br />&lt;link rel=&quot;stylesheet&quot; href=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css&quot; integrity=&quot;sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T&quot; crossorigin=&quot;anonymous&quot;&gt;<br />&lt;script src=&quot;https://code.jquery.com/jquery-3.2.1.slim.min.js&quot; integrity=&quot;sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;<br />&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js&quot; integrity=&quot;sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;<br />&lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js&quot; integrity=&quot;sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;<br /><br />&lt;script&gt;<br />% # when the page is closed have the browser send a POST<br />% # to /exit to tell Mojolicious to shut down<br />window.addEventListener(<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;unload&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;() =&gt; navigator.sendBeacon(&quot;/exit&quot;),<br />&nbsp;&nbsp;&nbsp;&nbsp;false<br />)<br />&lt;/script&gt;<br /><br />&lt;body&gt;<br /><br />&lt;script&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;var ws = new WebSocket(&lt;%== $websocket_address %&gt;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;// handle messages from Perl<br />&nbsp;&nbsp;&nbsp;&nbsp;ws.onmessage = (msg) =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var data = JSON.parse(msg.data)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// perl called us, call the named function and send the<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// results back over the websocket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (data.type == 'call') {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var result = window[data.payload.name](...data.payload.args)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ws.send(JSON.stringify({<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'type'    : 'response',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'id'      : data.id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'payload' : result<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;// trigger the on_ready events perl side when the connection<br />&nbsp;&nbsp;&nbsp;&nbsp;// has been established<br />&nbsp;&nbsp;&nbsp;&nbsp;ws.onopen = () =&gt; ws.send('{&quot;type&quot;:&quot;ready&quot;}')<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function perlCallback(name, ...args) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ws.send(JSON.stringify({<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'type'    : 'callback',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'payload' : {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'name' : name, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'args' : args<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}))<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&lt;/script&gt;<br /><br />% # include the per script html<br />&lt;main role=&quot;main&quot; class=&quot;container&quot;&gt;<br />%= include 'content'<br />&lt;/main&gt;<br /><br />&lt;script&gt;<br />$(() =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;// anything 'clickable' will call the 'id_clicked' callback<br />&nbsp;&nbsp;&nbsp;&nbsp;// in perl space when clicked (i.e. something with the id of<br />&nbsp;&nbsp;&nbsp;&nbsp;// &quot;foo&quot; will call the &quot;foo_clicked&quot; callback)<br />&nbsp;&nbsp;&nbsp;&nbsp;$('.clickable').on('click', function () {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var name = this.id + '_clicked'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perlCallback(name)<br />&nbsp;&nbsp;&nbsp;&nbsp;})<br />});<br />&lt;/script&gt;<br /><br />&lt;/body&gt;<br />&lt;/html&gt;</span></code><br />&nbsp;</td></table>

<h3 id="Writing-Something-More-Powerful">Writing Something More Powerful</h3>

<p>I&#39;ve got a directory full of plain text files containing all the notes I&#39;ve been collecting for that last five years or so. By now a lot of these are out of date.</p>

<p>What I need to do is write a GUI application that will allow me to view one note at a time, starting with the oldest first, and let me either trash the note or modify the title and body of the note to bring it up to date.</p>

<p>Maybe I can use the Wise Old Elf&#39;s tool to write that? What we want is something that looks like this:</p>

<p><center><img src="noteeditor.jpg" alt="Note Editor" width="500" height="309"></center>

</p>



<p>Finding the oldest file in the notes directory is easy with <a href="https://metacpan.org/module/List::UtilBy">List::UtilBy</a>. It returns the item from the passed list for which the code in the <code>{ ... }</code> produced the smallest value.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="symbol">$file</span> <span class="operator">=</span> <span class="word">min_by</span> <span class="structure">{</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">stat</span><span class="operator">-&gt;</span><span class="word">mtime</span> <span class="structure">}</span> <span class="symbol">$notes_dir</span><span class="operator">-&gt;</span><span class="word">children</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Once we have that we can just pass the title and contents of the file through to JavaScript</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$title</span>            <span class="operator">=</span> <span class="symbol">$file</span><span class="operator">-&gt;</span><span class="word">basename</span><span class="structure">(</span><span class="regexp">qr/.txt/</span><span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$contents_of_file</span> <span class="operator">=</span> <span class="symbol">$file</span><span class="operator">-&gt;</span><span class="word">slurp_utf8</span><span class="structure">;</span><br /><span class="word">await</span> <span class="word">call_javascript</span><span class="structure">(</span><span class="single">'updateNote'</span><span class="operator">,</span> <span class="symbol">$title</span><span class="operator">,</span> <span class="symbol">$contents_of_file</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Where it can update the forms:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synIdentifier">function</span> updateNote(title,contents) <span class="synIdentifier">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;$(<span class="synConstant">'#title'</span>).val(title);<br />&nbsp;&nbsp;&nbsp;&nbsp;$(<span class="synConstant">'#contents'</span>).val(contents);<br /><span class="synIdentifier">}</span></code><br />&nbsp;</td></table>

<p>And that&#39;s about it for the smarts. The rest is just simply reacting to button presses and writing out / moving the files.</p>

<p>Here&#39;s the full script - the entire application is no more than sixty lines of actual code.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;<br />65:&nbsp;<br />66:&nbsp;<br />67:&nbsp;<br />68:&nbsp;<br />69:&nbsp;<br />70:&nbsp;<br />71:&nbsp;<br />72:&nbsp;<br />73:&nbsp;<br />74:&nbsp;<br />75:&nbsp;<br />76:&nbsp;<br />77:&nbsp;<br />78:&nbsp;<br />79:&nbsp;<br />80:&nbsp;<br />81:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">QuickBrowserGUI</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::AsyncAwait</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Path::Tiny</span>    <span class="words">qw( path )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">List::UtilsBy</span> <span class="words">qw( min_by )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">File::Copy</span>    <span class="words">qw( move )</span><span class="structure">;</span><br /><br /><span class="comment"># where the files are kept<br /></span><span class="keyword">my</span> <span class="symbol">$notes_dir</span>   <span class="operator">=</span> <span class="word">path</span><span class="structure">(</span><span class="symbol">$ENV</span><span class="structure">{</span><span class="word">HOME</span><span class="structure">}</span><span class="operator">,</span> <span class="single">'notes'</span><span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$archive_dir</span> <span class="operator">=</span> <span class="word">path</span><span class="structure">(</span><span class="symbol">$ENV</span><span class="structure">{</span><span class="word">HOME</span><span class="structure">}</span><span class="operator">,</span> <span class="single">'.archived-notes'</span><span class="structure">);</span><br /><br /><span class="comment"># this is the current file we're working on<br /></span><span class="keyword">my</span> <span class="symbol">$file</span><span class="structure">;</span><br /><br /><span class="word">async</span> <span class="word">next_note</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">()</span> <span class="structure">{</span><br /><span class="comment">    # find the oldest file to work on <br /></span>    <span class="symbol">$file</span> <span class="operator">=</span> <span class="word">min_by</span> <span class="structure">{</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">stat</span><span class="operator">-&gt;</span><span class="word">mtime</span> <span class="structure">}</span> <span class="symbol">$notes_dir</span><span class="operator">-&gt;</span><span class="word">children</span><span class="structure">;</span><br /><br /><span class="comment">    # update the form in the browser<br />&nbsp;&nbsp;&nbsp;&nbsp;# title is the filename (without dir nor extension)<br /></span>    <span class="keyword">my</span> <span class="symbol">$title</span> <span class="operator">=</span> <span class="symbol">$file</span><span class="operator">-&gt;</span><span class="word">basename</span><span class="structure">(</span><span class="regexp">qr/.txt/</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$contents_of_file</span> <span class="operator">=</span> <span class="symbol">$file</span><span class="operator">-&gt;</span><span class="word">slurp_utf8</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">await</span> <span class="word">call_javascript</span><span class="structure">(</span><span class="single">'updateNote'</span><span class="operator">,</span> <span class="symbol">$title</span><span class="operator">,</span> <span class="symbol">$contents_of_file</span><span class="structure">);</span><br /><span class="structure">};</span><br /><br /><span class="word">callback</span> <span class="single">'save_clicked'</span> <span class="operator">=&gt;</span> <span class="word">async</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$new_data</span> <span class="operator">=</span> <span class="word">await</span> <span class="word">call_javascript</span><span class="structure">(</span><span class="single">'noteData'</span><span class="structure">);</span><br /><br /><span class="comment">    # write the note out, possibly in a new location<br /></span>    <span class="word">path</span><span class="structure">(</span> <span class="symbol">$notes_dir</span><span class="operator">,</span> <span class="symbol">$new_data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">title</span><span class="structure">}</span> <span class="operator">.</span> <span class="single">'.txt'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">spew_utf8</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$new_data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">contents</span><span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br /><span class="comment">    # if we renamed the note delete the old note<br /></span>    <span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$new_data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">title</span><span class="structure">}</span> <span class="operator">ne</span> <span class="symbol">$file</span><span class="operator">-&gt;</span><span class="word">basename</span><span class="structure">(</span><span class="regexp">qr/.txt/</span><span class="structure">))</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">unlink</span> <span class="symbol">$file</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next_note</span><span class="structure">();</span><br /><span class="structure">};</span><br /><br /><span class="word">callback</span> <span class="single">'archive_clicked'</span> <span class="operator">=&gt;</span> <span class="word">async</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">move</span><span class="structure">(</span><span class="symbol">$file</span><span class="operator">,</span> <span class="double">&quot;$ENV{HOME}/.notes-archive&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next_note</span><span class="structure">();</span><br /><span class="structure">};</span><br /><br /><span class="word">on_ready</span> <span class="word">async</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">next_note</span><span class="structure">()</span> <span class="structure">};</span><br /><span class="word">start</span><span class="structure">();</span><br /><br /><span class="separator">__DATA__</span><br /><span class="data"><br />@@ content.html.ep<br /><br />&lt;h1&gt;Edit Notes&lt;/h1&gt;<br /><br />&lt;div class=&quot;form-group&quot;&gt;<br />&lt;input id='title' class=&quot;form-control&quot;&gt;<br />&lt;/div&gt;<br /><br />&lt;div class=&quot;form-group&quot;&gt;<br />&lt;textarea id='contents' class=&quot;form-control&quot;&gt;&lt;/textarea&gt;<br />&lt;/div&gt;<br /><br />&lt;div class=&quot;form-group&quot;&gt;<br />&lt;button id='save'    class=&quot;btn btn-primary clickable float-right&quot;&gt;Save&lt;/button&gt;<br />&lt;button id='archive' class=&quot;btn btn-danger  clickable&quot;&gt;Archive&lt;/button&gt;<br />&lt;/div&gt;<br /><br />&lt;script&gt;<br />function noteData() {<br />&nbsp;&nbsp;&nbsp;&nbsp;return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'title'     : $('#title').val(),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'contents'  : $('#contents').val(),<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br />function updateNote(title,contents) {<br />&nbsp;&nbsp;&nbsp;&nbsp;$('#title').val(title);<br />&nbsp;&nbsp;&nbsp;&nbsp;$('#contents').val(contents);<br />}<br />&lt;/script&gt;</span></code><br />&nbsp;</td></table>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Awaiting Christmas" href="2019-12-10.html">Previous</a></li>

    <li class="next"><a title="Now With Added Interactivity" href="2019-12-12.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





