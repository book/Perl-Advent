<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Comparing More

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Comparing More</h1>
<div class='subtitle'>Test2::Compare::Base - 2019-12-22</div>

<div class='pod'><p>Cinnamon Candybubbles has been really interested in the Wise Old Elf&#39;s <a href="http://www.perladvent.org/2019/2019-12-21.html">lecture yesterday</a> on Test2. She&#39;d been particularly intregied by the comparison operators that allow you to build a complex datastructure of comparisons to pass into <code>is</code>.</p>

<p><a href="https://metacpan.org/module/Test2::Tools::Compare">Test2::Tools::Compare</a> lists a whole bunch of these operators that are immediately available in <a href="https://metacpan.org/module/Test2::V0">Test2::V0</a>. But what she wanted to extend the operators?</p>

<p>What Cinnamon wants to do is write a simple comparison function that she can use to check if a value is one of Santa&#39;s reindeer or not.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Test2::Tools::SantasReindeer</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$ds</span> <span class="operator">=</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">reindeer</span> <span class="operator">=&gt;</span> <span class="structure">[</span> <span class="single">'Donner'</span><span class="operator">,</span> <span class="single">'Prancer'</span><span class="operator">,</span> <span class="single">'Robbie'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">driver</span>   <span class="operator">=&gt;</span> <span class="single">'Santa'</span><span class="operator">,</span><br /><span class="structure">};</span><br /><br /><span class="comment"># insist that all reindeer are Santa's reindeer<br /></span><span class="word">is</span><span class="structure">(</span><span class="symbol">$ds</span><span class="operator">,</span> <span class="word">hash</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">field</span> <span class="word">reindeer</span> <span class="operator">=&gt;</span> <span class="word">array</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">all_items</span><span class="structure">(</span><span class="word">santas_reindeer</span><span class="structure">());</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">etc</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">etc</span><span class="structure">();</span><br /><span class="structure">});</span><br /><br /><span class="word">done_testing</span><span class="structure">();</span></code><br />&nbsp;</td></table>

<p>How can she do this?</p>

<h3 id="Writing-a-Test2::Tools-Class">Writing a Test2::Tools Class</h3>

<p>Test2&#39;s standard extension mechanism is to provide tools in the <code>Test2::Tools</code> namespace that provide functions that interoperate with existing Test2 functionality. These classes don&#39;t need to subclass any particular class nor have any specific functions or method defined - they can access anything they need to about the Test2 context by using the <code>context</code> function from <a href="https://metacpan.org/module/Test2::API">Test2::API</a>.</p>

<p>In this case Cinnamon isn&#39;t even going to do that - she&#39;s not actually writing any code that performs a test per se. She&#39;s providing a function that the tests in <a href="https://metacpan.org/module/Test2::Tools::Compare">Test2::Tools::Compare</a> can use to compare data structures.</p>

<p>Writing a Test2::Tools class that exports comparison functions isn&#39;t that hard - it&#39;s just like any other Exporter based code.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Test2::Tools::SantasReindeer</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Exporter</span> <span class="words">qw( import )</span><span class="structure">;</span><br /><span class="keyword">our</span> <span class="symbol">@EXPORT</span> <span class="operator">=</span> <span class="words">qw( santas_reindeer )</span><span class="structure">;</span><br /><br /><span class="comment"># we're going to re-use existing Test2 comparison classes<br /></span><span class="keyword">use</span> <span class="word">Test2::Compare::Set</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Test2::Compare::String</span><span class="structure">;</span><br /><br /><span class="comment"># return the same as in_set(qw(Rudolph Dasher Dancer...))<br /></span><span class="keyword">sub</span> <span class="word">santas_reindeer</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$set</span> <span class="operator">=</span> <span class="word">Test2::Compare::Set</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">checks</span> <span class="operator">=&gt;</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">map</span> <span class="structure">{</span> <span class="word">Test2::Compare::String</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">input</span> <span class="operator">=&gt;</span> <span class="magic">$_</span> <span class="structure">)</span> <span class="structure">}</span> <span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rudolph Dasher Dancer Prancer Vixen Comet Cupid Donner Blitzen<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">]);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$set</span><span class="operator">-&gt;</span><span class="word">set_reduction</span><span class="structure">(</span><span class="single">'any'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$set</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>This works, and correctly identifies that <code>Robbie</code> is not one of Santa&#39;s reindeer:</p>

<pre><code>    shell$  perl -Ilib /tmp/testing.t
    not ok 1
    # Failed test at /tmp/testing.t line 17.
    # +-------------------------+-----------------------+----+---------+--------+
    # | PATH                    | GOT                   | OP | CHECK   | LNs    |
    # +-------------------------+-----------------------+----+---------+--------+
    # |                         | HASH(0x7f9fab817670)  |    | &lt;HASH&gt;  | 14, 17 |
    # | {reindeer}              | ARRAY(0x7f9fab817658) |    | &lt;ARRAY&gt; | 15     |
    # | {reindeer}[2] &lt;Check 0&gt; | Robbie                | eq | Rudolph |        |
    # | {reindeer}[2] &lt;Check 1&gt; | Robbie                | eq | Dasher  |        |
    # | {reindeer}[2] &lt;Check 2&gt; | Robbie                | eq | Dancer  |        |
    # | {reindeer}[2] &lt;Check 3&gt; | Robbie                | eq | Prancer |        |
    # | {reindeer}[2] &lt;Check 4&gt; | Robbie                | eq | Vixen   |        |
    # | {reindeer}[2] &lt;Check 5&gt; | Robbie                | eq | Comet   |        |
    # | {reindeer}[2] &lt;Check 6&gt; | Robbie                | eq | Cupid,  |        |
    # | {reindeer}[2] &lt;Check 7&gt; | Robbie                | eq | Donner  |        |
    # | {reindeer}[2] &lt;Check 8&gt; | Robbie                | eq | Blitzen |        |
    # +-------------------------+-----------------------+----+---------+--------+</code></pre>

<p>Though it&#39;s a little on the verbose side - the Cinnamon doesn;t really want to know all the names that don&#39;t match, they want to simply know that it doesn&#39;t match any of Santa&#39;s reindeer</p>

<h3 id="Writing-a-Custom-Comparison">Writing a Custom Comparison</h3>

<p>The tools we previously wrote simply re-used existing comparisons. How about Cinnamon writes her own comparison operator, so she can have full control over the output?</p>

<p>This makes her Tools module considerable simplier at least..</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Test2::Tools::SantasReindeer</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Exporter</span> <span class="words">qw( import )</span><span class="structure">;</span><br /><span class="keyword">our</span> <span class="symbol">@EXPORT</span> <span class="operator">=</span> <span class="words">qw( santas_reindeer )</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Test2::Compare::SantasReindeer</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">santas_reindeer</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">Test2::Compare::SantasReindeer</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Test2::Compare::SantasReindeer should be a subclass of the <a href="https://metacpan.org/module/Test2::Compare::Base">Test2::Compare::Base</a> class. A simple implementation would be:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Test2::Compare::SantasReindeer</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">base</span> <span class="words">qw(Test2::Compare::Base)</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">List::Util</span> <span class="words">qw( any )</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">name</span> <span class="structure">{</span> <span class="double">&quot;Santa's Reindeer&quot;</span> <span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">verify</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">%params</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br /><span class="comment">    # if this value didn't exist at all, need to return false<br /></span>    <span class="keyword">return</span> <span class="number">0</span> <span class="word">unless</span> <span class="symbol">$params</span><span class="structure">{</span><span class="word">exists</span><span class="structure">};</span><br /><br /><span class="comment">    # return true if and only if what we got matches<br /></span>    <span class="keyword">return</span> <span class="word">any</span> <span class="structure">{</span> <span class="symbol">$params</span><span class="structure">{</span><span class="word">got</span><span class="structure">}</span> <span class="operator">eq</span> <span class="magic">$_</span> <span class="structure">}</span> <span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rudolph Dasher Dancer Prancer Vixen Comet Cupid Donner Blitzen<br />&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Cinnamon had to implement two methods: <code>name</code> (which returns the name of the test that will be shown in output) and <code>verify</code> (which returns true or false if it matches or not).</p>

<p>The output is much more readable now</p>

<pre><code>    shell$ $  perl -Ilib /tmp/testing.t
    not ok 1
    # Failed test at /tmp/testing.t line 17.
    # +---------------+-----------------------+------------------+--------+
    # | PATH          | GOT                   | CHECK            | LNs    |
    # +---------------+-----------------------+------------------+--------+
    # |               | HASH(0x7f917f001870)  | &lt;HASH&gt;           | 14, 17 |
    # | {reindeer}    | ARRAY(0x7f917f001858) | &lt;ARRAY&gt;          | 15     |
    # | {reindeer}[2] | Robbie                | Santa&#39;s Reindeer |        |
    # +---------------+-----------------------+------------------+--------+</code></pre>

<h3 id="Embracing-The-Negative">Embracing The Negative</h3>

<p>Ever since the cuban missile crisis Grand-Santa hasn&#39;t been allowed to fly the sliegh any more. This is easy to express in a test with the <code>!</code> operator:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$ds</span> <span class="operator">=</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">driver</span> <span class="operator">=&gt;</span> <span class="single">'Grand-Santa'</span><span class="operator">,</span><br /><span class="structure">};</span><br /><br /><span class="comment"># no Grand-Santa!<br /></span><span class="word">is</span><span class="structure">(</span><span class="symbol">$ds</span><span class="operator">,</span> <span class="word">hash</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">field</span> <span class="word">driver</span> <span class="operator">=&gt;</span> <span class="operator">!</span><span class="word">string</span><span class="structure">(</span><span class="double">&quot;Grand-Santa&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">etc</span><span class="structure">();</span><br /><span class="structure">});</span></code><br />&nbsp;</td></table>

<p>This helpfully prints out useful info in the diagnostics making it clear that the test was negated too.</p>

<pre><code>    # Seeded srand with seed &#39;20191220&#39; from local date.
    not ok 1
    # Failed test at - line 12.
    # +----------+----------------------+----+-------------+-------+
    # | PATH     | GOT                  | OP | CHECK       | LNs   |
    # +----------+----------------------+----+-------------+-------+
    # |          | HASH(0x7fa50d817040) |    | &lt;HASH&gt;      | 9, 12 |
    # | {driver} | Grand-Santa          | ne | Grand-Santa | 10    |
    # +----------+----------------------+----+-------------+-------+</code></pre>

<p>What if Cinnamon does&#39;t want any of Santa&#39;s reindeer on our sleigh? It should be as simple as writing the following:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Test2::Tools::SantasReindeer</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$ds</span> <span class="operator">=</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">type</span>     <span class="operator">=&gt;</span> <span class="single">'training flight'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">reindeer</span> <span class="operator">=&gt;</span> <span class="structure">[</span> <span class="single">'Donner'</span><span class="operator">,</span> <span class="single">'Prancer'</span><span class="operator">,</span> <span class="single">'Robbie'</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">driver</span>   <span class="operator">=&gt;</span> <span class="single">'Arthur'</span><span class="operator">,</span><br /><span class="structure">};</span><br /><br /><span class="comment"># insist that all reigndeer aren't Santa's<br /></span><span class="word">is</span><span class="structure">(</span><span class="symbol">$ds</span><span class="operator">,</span> <span class="word">hash</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">field</span> <span class="word">reindeer</span> <span class="operator">=&gt;</span> <span class="word">array</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">all_items</span><span class="structure">(</span><span class="operator">!</span><span class="word">santas_reindeer</span><span class="structure">());</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">etc</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">etc</span><span class="structure">();</span><br /><span class="structure">});</span><br /><br /><span class="word">done_testing</span><span class="structure">();</span></code><br />&nbsp;</td></table>

<p>Does that work?</p>

<pre><code>    perl -Ilib /tmp/testing.t
    # Seeded srand with seed &#39;20191220&#39; from local date.
    not ok 1
    # Failed test at /tmp/testing.t line 18.
    # +---------------+-----------------------+----+---------+--------+
    # | PATH          | GOT                   | OP | CHECK   | LNs    |
    # +---------------+-----------------------+----+---------+--------+
    # |               | HASH(0x7f9501017670)  |    | &lt;HASH&gt;  | 15, 18 |
    # | {reindeer}    | ARRAY(0x7f9501017658) |    | &lt;ARRAY&gt; | 16     |
    # | {reindeer}[0] | Donner                | eq |         |        |
    # | {reindeer}[1] | Prancer               | eq |         |        |
    # | {reindeer}[2] | Robbie                | eq |         |        |
    # +---------------+-----------------------+----+---------+--------+</code></pre>

<p>Ooops, Cinnamon now checking that the names are equal to false. What changes does she have to make?</p>

<p>The Test2::Compare::SantasReindeer needs to overload the <code>!</code> operator, save that in the instance, and then the code can decide what comparison to run in <code>verify</code> later on.</p>

<p>Thankfully, Cinnamon doesn&#39;t have to code all of that - the overloading aspect can be handled just by loading <a href="https://metacpan.org/module/Test2::Compare::Negatable">Test2::Compare::Negatable</a> which will set the <code>+NEGATED</code> attribute for us.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Test2::Compare::SantasReindeer</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">base</span> <span class="words">qw(Test2::Compare::Base)</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">List::Util</span> <span class="words">qw( any none )</span><span class="structure">;</span><br /><br /><span class="comment"># Overloads '!' for us.<br /></span><span class="keyword">use</span> <span class="word">Test2::Compare::Negatable</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">@REINDEER</span> <span class="operator">=</span> <span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;Rudolph Dasher Dancer Prancer Vixen Comet Cupid Donner Blitzen<br />)</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">name</span> <span class="structure">{</span> <span class="double">&quot;Santa's Reindeer&quot;</span> <span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">verify</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">%params</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br /><span class="comment">    # Always check if $got exists! This method must return false if no<br />&nbsp;&nbsp;&nbsp;&nbsp;# value at all was received.<br /></span>    <span class="keyword">return</span> <span class="number">0</span> <span class="word">unless</span> <span class="symbol">$params</span><span class="structure">{</span><span class="word">exists</span><span class="structure">};</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">none</span> <span class="structure">{</span> <span class="symbol">$params</span><span class="structure">{</span><span class="word">got</span><span class="structure">}</span> <span class="operator">eq</span> <span class="magic">$_</span> <span class="structure">}</span> <span class="symbol">@REINDEER</span> <span class="word">if</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="operator">+</span><span class="word">NEGATE</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">any</span>  <span class="structure">{</span> <span class="symbol">$params</span><span class="structure">{</span><span class="word">got</span><span class="structure">}</span> <span class="operator">eq</span> <span class="magic">$_</span> <span class="structure">}</span> <span class="symbol">@REINDEER</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Now Cinnamon&#39;s test works as it should:</p>

<pre><code>    mark@Tarrant:~/tmp$  perl -Ilib /tmp/testing.t
    # Seeded srand with seed &#39;20191220&#39; from local date.
    not ok 1
    # Failed test at /tmp/testing.t line 18.
    # +---------------+-----------------------+------------------+--------+
    # | PATH          | GOT                   | CHECK            | LNs    |
    # +---------------+-----------------------+------------------+--------+
    # |               | HASH(0x7f857200ea70)  | &lt;HASH&gt;           | 15, 18 |
    # | {reindeer}    | ARRAY(0x7f857200ea58) | &lt;ARRAY&gt;          | 16     |
    # | {reindeer}[0] | Donner                | Santa&#39;s Reindeer |        |
    # | {reindeer}[1] | Prancer               | Santa&#39;s Reindeer |        |
    # +---------------+-----------------------+------------------+--------+</code></pre>

<p>But the output is still a little confusing; Currently the diagnostics are saying that the problem is that Donner and Prancer aren&#39;t Santa&#39;s Reindeer when the point of the test was that they are, but we don&#39;t want them to be.</p>

<p>Cinnamon has one more method to override in the class to get the output she desires:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">operator</span> <span class="structure">{</span> <span class="core">shift</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="operator">+</span><span class="word">NEGATE</span><span class="structure">}</span> <span class="operator">?</span> <span class="double">&quot;isn't one of&quot;</span> <span class="operator">:</span> <span class="double">&quot;is one of&quot;</span> <span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now the output looks like</p>

<pre><code>    shell$ perl -Ilib /tmp/testing.t
    not ok 1
    # Failed test at /tmp/testing.t line 18.
    # +---------------+-----------------------+--------------+------------------+--------+
    # | PATH          | GOT                   | OP           | CHECK            | LNs    |
    # +---------------+-----------------------+--------------+------------------+--------+
    # |               | HASH(0x7ff5e2802870)  |              | &lt;HASH&gt;           | 15, 18 |
    # | {reindeer}    | ARRAY(0x7ff5e2802858) |              | &lt;ARRAY&gt;          | 16     |
    # | {reindeer}[0] | Donner                | isn&#39;t one of | Santa&#39;s Reindeer |        |
    # | {reindeer}[1] | Prancer               | isn&#39;t one of | Santa&#39;s Reindeer |        |
    # +---------------+-----------------------+--------------+------------------+--------+</code></pre>

<p>Or</p>

<pre><code>    shell$ perl -Ilib /tmp/testing.t
    not ok 1
    # Failed test at /tmp/testing.t line 18.
    # +---------------+-----------------------+-----------+------------------+--------+
    # | PATH          | GOT                   | OP        | CHECK            | LNs    |
    # +---------------+-----------------------+-----------+------------------+--------+
    # |               | HASH(0x7f8687017670)  |           | &lt;HASH&gt;           | 15, 18 |
    # | {reindeer}    | ARRAY(0x7f8687017658) |           | &lt;ARRAY&gt;          | 16     |
    # | {reindeer}[2] | Robbie                | is one of | Santa&#39;s Reindeer |        |
    # +---------------+-----------------------+-----------+------------------+--------+</code></pre>

<h3 id="Comparatively-Good">Comparatively Good</h3>

<p>Cinnamon Candybubbles ended up with a comparison that was not only quick to type, but more importantly very easy to understand when looking at the diagnostic output.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Test2: Test Harder (but easier)" href="2019-12-21.html">Previous</a></li>

    <li class="next"><a title="Testing our Impatience" href="2019-12-23.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





