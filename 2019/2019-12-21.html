<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Test2: Test Harder (but easier)

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Test2: Test Harder (but easier)</h1>
<div class='subtitle'>Test2::V0 - 2019-12-21</div>

<div class='pod'><p>&quot;Right, my fellow Elves, calm down&quot;, the Wise Old Elf shouted over the rabble gathed in the elf lecture hall, &quot;Today I&#39;m going to be talking to you about Testing&quot;</p>

<p>There were loud groans from the audience. They&#39;d been writing tests for <i>years</i>. It was like teaching their Grandmother to suck Eggnog.</p>

<p>&quot;Now now...how many of you are familiar with the latest changes in Test2?&quot;</p>

<p>Less noise now. Maybe there was something here they could learn after all.</p>

<p>&quot;There&#39;s so much to cover. I could tell you about the underlying event system that allows decoupling of parts of the test system. I could talk about the new structure of creating interoperable test frameworks. I could talk to about the new harness features...but today, today I&#39;m going to talk to you about <a href="https://metacpan.org/module/Test2::V0">Test2::V0</a>.</p>

<p>Test2::V0 is like a smorgasbord of all the good bits of Test2 wrapped up in one delectable package. When you might previously grab Test::More, you should grab Test2::V0. Because...because it not only uses all of the cool tech on its backend, but because it&#39;s so darn handy to use.&quot;</p>

<h3 id="Making-the-Easy-Stuff-Easy:-Strictness-Warnings-and-UTF8">Making the Easy Stuff Easy: Strictness, Warnings and UTF8</h3>

<p>&quot;Lazyness! One of the greatest virtue of the Perl programmer! Why type a lot when you can type a little? Why not have sensible defaults.&quot;</p>

<p>There were plenty of nodding heads now. Writing tests is a Cost of Doing Business - so making it as simple as possible to do the right thing without thinking about it is critical.</p>

<p>The Wise Old Elf threw the most basic Perl script up on the screen.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Test::More</span> <span class="word">tests</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="structure">;</span><br /><br /><span class="word">ok</span><span class="structure">(</span><span class="number">1</span><span class="operator">,</span> <span class="single">'Do we want to build a \N{SNOWMAN}?'</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;Now here&#39;s the same code written in an idiomatic fashion with Test2::V0.&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span><br /><br /><span class="word">ok</span><span class="structure">(</span><span class="number">1</span><span class="operator">,</span> <span class="double">&quot;Do you want to build a \N{SNOWMAN}?&quot;</span><span class="structure">);</span><br /><br /><span class="word">done_testing</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>&quot;Who can spot the difference?&quot;</p>

<p>Tiramisu Shinytree raised her hand. &quot;There&#39;s no strict or warnings!&quot;</p>

<p>&quot;Correct! Test2::V0 (like Moose, Mojolicious, and many other common tools) turns those on for you automatically. Anything else?&quot;</p>

<p>It was Bluebell Brandycake&#39;s turn. &quot;There&#39;s no plan!&quot;</p>

<p>&quot;Well yes, Test2 allows you to use <code>done_testing</code> rather than having to count each and every test and declare a plan, but modern versions of Test::More allow that too. Anything else? Anyone spot the bug?&quot;</p>

<p>Silence. Can you spot it? The Wise Old Elf decided to show the class the output of the scripts.</p>

<pre><code>    shell $ perl /tmp/more.t
    1..1
    Wide character in print at /opt/perl/bin/lib/site_perl/5.28.1/Test2/Formatter/TAP.pm line 144.
    ok 1 - Do you want to build a X?

    shell $ perl /tmp/2v0.t
    ok 1 - Do you want to build a X?
    1..1</code></pre>

<p>The crowd groaned. They&#39;d forgotten Fowler&#39;s Rule on Unicode (there&#39;s always another unicode bug, you just haven&#39;t found it yet)</p>

<p>&quot;Yep. Test2::V0 also reconfigures the output handles to encode as UTF-8 which I bet you always forget - until you see that warning message.&quot;</p>

<h3 id="Deep-Testing">Deep Testing</h3>

<p>&quot;The next thing you&#39;ll notice is that Test2::V0 based tests are, well, naturally <i>deeper</i> than their Test::More counterparts. Where in Test::More if you wanted to test data structures you&#39;d have to use <code>is_deeply</code>...&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Test::More</span> <span class="word">tests</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Reindeer::Santa</span>  <span class="words">qw(original_team)</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">@results</span> <span class="operator">=</span> <span class="word">original_team</span><span class="structure">();</span><br /><br /><span class="word">is_deeply</span><span class="structure">(</span><span class="cast">\</span><span class="symbol">@original_tam</span><span class="operator">,</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Dasher'</span><span class="operator">,</span> <span class="single">'Dancer'</span><span class="operator">,</span> <span class="single">'Prancer'</span><span class="operator">,</span> <span class="single">'Vixen'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Comet'</span><span class="operator">,</span> <span class="single">'Cupid'</span><span class="operator">,</span> <span class="single">'Donner'</span><span class="operator">,</span> <span class="single">'Blitzen'</span><span class="operator">,</span><br /><span class="structure">]</span><span class="operator">,</span> <span class="single">'check reindeer'</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;With Test2::V0 you&#39;d just use <code>is</code>.&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Test2::V0</span><br /><br /><span class="keyword">use</span> <span class="word">Reindeer::Santa</span>  <span class="words">qw(original_team)</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">@results</span> <span class="operator">=</span> <span class="word">original_team</span><span class="structure">();</span><br /><br /><span class="word">is</span><span class="structure">(</span><span class="cast">\</span><span class="symbol">@original_tam</span><span class="operator">,</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Dasher'</span><span class="operator">,</span> <span class="single">'Dancer'</span><span class="operator">,</span> <span class="single">'Prancer'</span><span class="operator">,</span> <span class="single">'Vixen'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Comet'</span><span class="operator">,</span> <span class="single">'Cupid'</span><span class="operator">,</span> <span class="single">'Donner'</span><span class="operator">,</span> <span class="single">'Blitzen'</span><span class="operator">,</span><br /><span class="structure">]</span><span class="operator">,</span> <span class="single">'check reindeer'</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>The Wise Old Elf went onto explain it was so much more. To demonstrate, he set a little programming exercise.</p>

<p>Write a test that checks the output is a hashref that has three entries in it. The first is a name (which must be a string). The second is an age which must be equal to eighteen or the string &quot;adult&quot;. The third is an info array that has four elements: A true value, an instance of Snowman, an instance that has an <code>as_string</code> method that returns <code>Anna</code>, and finally something that is a valid RFC 1123 date time. The top level hash can have any other alphanumeric keys except <code>error</code>.</p>

<p>The elves spent a long time producing page after page of code. There were debates. Arguments. And thirty minutes later no-one was done.</p>

<p>They were quite shocked when the Wise Old elf showed them his simple solution:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">is</span><span class="structure">(</span><span class="symbol">$data</span><span class="operator">,</span> <span class="word">hash</span> <span class="structure">{</span><br /><span class="comment">   # insist that name is a string (not a ref, etc!)<br /></span>   <span class="word">field</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="word">match</span> <span class="regexp">qr//</span><span class="structure">;</span><br /><br /><span class="comment">   # insist that the person's age 18 (or 18.0, etc) or &quot;adult&quot;<br /></span>   <span class="word">field</span> <span class="word">age</span>  <span class="operator">=&gt;</span> <span class="word">in_set</span><span class="structure">(</span><span class="word">number</span><span class="structure">(</span><span class="number">18</span><span class="structure">)</span><span class="operator">,</span> <span class="double">&quot;adult&quot;</span><span class="structure">);</span><br /><br /><span class="comment">   # info is an array<br /></span>   <span class="word">field</span> <span class="word">info</span> <span class="operator">=&gt;</span> <span class="word">array</span> <span class="structure">{</span><br /><span class="comment">       # the first element must be a true value<br /></span>       <span class="word">item</span> <span class="word">T</span><span class="structure">();</span><br /><br /><span class="comment">       # the second element must be an instance of Snowman<br /></span>       <span class="word">item</span> <span class="word">object</span> <span class="structure">{</span> <span class="word">blessed</span> <span class="operator">=&gt;</span> <span class="single">'Snowman'</span> <span class="structure">};</span><br /><br /><span class="comment">       # the third element must return 'Anna' when as_string is called on it<br /></span>       <span class="word">item</span> <span class="word">object</span> <span class="structure">{</span> <span class="word">call</span> <span class="word">as_string</span> <span class="operator">=&gt;</span> <span class="single">'Anna'</span> <span class="structure">};</span><br /><br /><span class="comment">       # the fourth element must be parseable as a RFC 1123 time<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the validator sub must return true if passes, false if not<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# (and Try::Tiny's try returns undef on exception)<br /></span>       <span class="word">item</span> <span class="word">validator</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">try</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">DateTime::Format::HTTP</span><span class="operator">-&gt;</span><span class="word">parse_datetime</span><span class="structure">(</span> <span class="magic">$_</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><br /><span class="comment">       # and there must only be four elements<br /></span>       <span class="word">end</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><br /><span class="comment">   # we don't want a field called &quot;error&quot;<br /></span>   <span class="word">field</span> <span class="word">error</span> <span class="operator">=&gt;</span> <span class="word">DNE</span><span class="structure">();</span>  <span class="comment"># does not exist</span><br /><br /><span class="comment">   # allow any other fields that keys are alphanumeric<br /></span>   <span class="word">all_keys</span><span class="structure">(</span><span class="word">match</span> <span class="regexp">qr/^[A-Za-z0-9]+$/aa</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;<span class="word">etc</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span> <span class="double">&quot;compare&quot;</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<h3 id="Exception-Checking">Exception Checking</h3>

<p>&quot;Sparkle Candytoes, what are an elf&#39;s favorite colors?&quot;</p>

<p>Sparkle beamed. &quot;Red and Green, Wise Old Elf&quot;</p>

<p>&quot;Correct! When we write good tests we don&#39;t just test the <i>green</i> path - what our code does wh its supposed to, we also check the <i>red</i> path. Does it handle hte errors correctly&quot;.</p>

<p>&quot;We want to make sure that our code throws the right exceptions. Without the exception breaking our test of course! Test2::V0 has its own exception capturing code:&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>&nbsp;<span class="keyword">use</span> <span class="pragma">autodie</span><span class="structure">;</span><br /><br /><span class="word">ok</span><span class="structure">(</span><span class="word">dies</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">open</span> <span class="word">my</span> <span class="symbol">$fh</span><span class="operator">,</span> <span class="double">&quot;&lt;&quot;</span><span class="operator">,</span> <span class="double">&quot;file-that-does-not-exist&quot;</span><span class="structure">;</span><br /><span class="structure">}</span><span class="operator">,</span> <span class="single">'open throws exception on non existent file'</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;Since <code>dies</code> returns the actual exception thrown we can improve the test, by checking if the exception contained the right string:</p>

<pre><code>    like(dies {
       open my $fh, &quot;&lt;&quot;, &quot;file-that-does-not-exist&quot;;
    }, qr/No such file/, &#39;open throws exception on non existent file&#39;);</code></pre>

<p>Or even check that something dies with the right kind of errors</p>

<pre><code>    isa_ok(dies {
        Mojo::Exception-&gt;throw(&#39;boom&#39;)
    }, &#39;Mojo::Exception&#39;, &#39;exception was an instance of Mojo::Exception);</code></pre>

<h3 id="Subtests">Subtests</h3>

<p>&quot;Now class, who can spot the problem with this code?&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Test::More</span><span class="structure">;</span><br /><br /><span class="word">subtest</span> <span class="single">'horse'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="symbol">$cart</span><span class="operator">,</span> <span class="single">'cart'</span><span class="operator">,</span> <span class="single">'cart'</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="word">done_testing</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>No hands up. &quot;Cinnamon Candybubbles, how about you&quot;.</p>

<p>&quot;I think it works, Wise Old Elf&quot;</p>

<p>&quot;Oh, it does, it does. It just looks confusing&quot;</p>

<pre><code>    # Subtest: horse
        not ok 1 - cart
        #   Failed test &#39;cart&#39;
        #   at - line 4.
        #          got: undef
        #     expected: &#39;cart&#39;
        1..1
        # Looks like you failed 1 test of 1.
    not ok 1 - horse
    #   Failed test &#39;horse&#39;
    #   at - line 5.
    1..1</code></pre>

<p>&quot;You have to read the comments to figure out what&#39;s going on. The cart is literally before the horse.&quot;</p>

<p>The Wise Old Elf showed them the same code in Test2::V0:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Test2::V0</span><span class="structure">;</span>  <span class="comment"># only this line changed!</span><br /><br /><span class="word">subtest</span> <span class="single">'horse'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="symbol">$cart</span><span class="operator">,</span> <span class="single">'cart'</span><span class="operator">,</span> <span class="single">'cart'</span><span class="structure">;</span><br /><span class="structure">};</span><br /><br /><span class="word">done_testing</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>But the output is very different</p>

<pre><code>    not ok 1 - horse {
        not ok 1 - cart
        # Failed test &#39;cart&#39;
        # at - line 5.
        # +---------+-------+
        # | GOT     | CHECK |
        # +---------+-------+
        # | &lt;UNDEF&gt; | cart  |
        # +---------+-------+
        1..1
    }
    # Failed test &#39;horse&#39;
    # at - line 6.
    1..1</code></pre>

<h3 id="And-More">And More</h3>

<p>&quot;Now class, I&#39;d like to talk to you about...&quot;, began the Wise Old Elf, only to be interrupted by the ringing of the lunch bell. Test2 is a big topic. More will have to wait for another day...</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Controlling your Terminal with Perl" href="2019-12-20.html">Previous</a></li>

    <li class="next"><a title="Comparing More" href="2019-12-22.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





