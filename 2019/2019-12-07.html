<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Show Me Mo&#39;

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Show Me Mo&#39;</h1>
<div class='subtitle'>Mo - 2019-12-07</div>

<div class='pod'><p>Conifer Sweetbaker, Software Programmer Elf second class grumbled. Despite what the Wise Old Elf insisted about maintaining the quality of the code they used at the North Pole, Conifer had to admit it to himself: He hated doing code reviews. And there was no code that he hated reviewing more than his best friend Currant Northwick&#39;s spaghetti code.</p>

<p>The Elf&#39;s code was a mess of Perl that looks like it had been written before the first dot com boom. There were mostly no objects and Conifer had already caught more than one case where there&#39;d been a typo in the hash keys (if those had just been objects and method calls Currant would have got a proper error message.) Occasionally Currant did deign to use an object - or at least that&#39;s what Conifer thought he was doing by the smattering of <code>new</code> and <code>bless</code> that peppered his code, but worryingly, there was a lack of accessor methods and direct access into the blessed hash all over the shop.</p>

<p>&quot;Why, for Santa&#39;s sake, WHY? It&#39;s as if you&#39;d never heard of Moose&quot; he cajoled his buddy.</p>

<p><a href="https://metacpan.org/module/Moose">Moose</a> was of course the object framework of choice at the North Pole. The powerful postmodern object system not only provides a awesome abstraction for defining object classes and accessor methods beyond the primitive <code>bless</code> keywords, but also provides a rich meta object protocol the envy of many lesser languages.</p>

<p>&quot;Too slow startup time&quot;, Conifer complained. &quot;And I couldn&#39;t get it installed on the old development platform over in the southern workshop - they don&#39;t have a C compiler for installing software like that&quot;.</p>

<p>Conifer didn&#39;t want to argue with his friend. When Moose programs start up they do take a little longer than basic Perl code that doesn&#39;t maintain a meta object protocol. And yes, you need a working compiler to install Moose&#39;s dependencies (or the ability to apt-get install it - Moose is widely distributed in the ten years or so it&#39;s been the defacto standard in Perl.) Conifer wasn&#39;t sure which system Currant was talking about (all buildings surrounding the North Pole are to the south) but he realized he just didn&#39;t want to argue.</p>

<p>&quot;How about Moo? That&#39;s quick.&quot;, Conifer tried a conciliatory suggestion.</p>

<p>&quot;Still slower than coding it by hand!&quot;, Currant quipped, &quot;Still needs an external dependency! And still too much typing.&quot;</p>

<p>There was no satisfying some elves. Moo is set of pure Perl classes that offered a subset of the Moose syntax that&#39;ll do very nicely if for any number of reasons you can&#39;t use Moose. But Conifer really wanted something as portable, quick and with as little typing as writing the broken frameworkless code he was trying to maintain now.</p>

<p>There&#39;s really no arguing with some Elves.</p>

<p>&quot;I know what you want,&quot; Conifer laughted, &quot;You want Mo, Baby!&quot;</p>

<h3 id="Mo">Mo</h3>

<p>If Moo is a cut down version of Moose, then <a href="https://metacpan.org/module/Mo">Mo</a> is a super trimmed to the bone and then slightly further implementation of something not too dissimilar to Moo in as little code as humanly possible.</p>

<p>Mo is like a super-terse version of Moose suitable for prototyping and quick one off scripts. For example, if you need to get a bunch of super heros together very, very quickly:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><br /><span class="keyword">package</span> <span class="word">Person</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mo</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'name'</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'codename'</span><span class="structure">;</span><br /><br /><span class="keyword">package</span> <span class="word">Team</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mo</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'members'</span><span class="structure">;</span><br /><span class="keyword">sub</span> <span class="word">assemble</span> <span class="structure">{</span> <span class="word">say</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">name</span><span class="operator">.</span><span class="single">' assemble!'</span> <span class="word">for</span> <span class="core">shift</span><span class="operator">-&gt;</span><span class="word">members</span><span class="operator">-&gt;</span><span class="cast">@*</span> <span class="structure">}</span><br /><br /><span class="keyword">package</span> <span class="word">main</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$avengers</span> <span class="operator">=</span> <span class="word">Team</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">members</span> <span class="operator">=&gt;</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Person</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Bruce Banner'</span><span class="operator">,</span> <span class="word">codename</span> <span class="operator">=&gt;</span> <span class="single">'The Hulk'</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Person</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Clint Barton'</span><span class="operator">,</span> <span class="word">codename</span> <span class="operator">=&gt;</span> <span class="single">'Hawkeye'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Person</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Natasha Romanoff'</span><span class="operator">,</span> <span class="word">codename</span> <span class="operator">=&gt;</span> <span class="single">'Black Widow'</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Person</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Steve Rogers'</span><span class="operator">,</span> <span class="word">codename</span> <span class="operator">=&gt;</span> <span class="single">'Captain America'</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Person</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Tony Stark'</span><span class="operator">,</span> <span class="word">codename</span> <span class="operator">=&gt;</span> <span class="single">'Ironman'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">]</span><span class="operator">,</span><br /><span class="structure">);</span><br /><span class="word">print</span> <span class="symbol">$avengers</span><span class="operator">-&gt;</span><span class="word">assemble</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<h3 id="Brevity">Brevity</h3>

<p>Just like Moose and Moo, Mo creates the constructor for your object class for you and allows you to define accessor methods with the handy <code>has</code> syntax.</p>

<p>However, whereas Moose and Moo require at least an <code>is</code> directive like so:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Person</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span><br /><span class="word">has</span> <span class="word">name</span>     <span class="operator">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'rw'</span><span class="structure">);</span><br /><span class="word">has</span> <span class="word">codename</span> <span class="operator">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'rw'</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Mo allows you to skip all the boilerplate if you want.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Person</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mo</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'name'</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'codename'</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>That doesn&#39;t mean Mo isn&#39;t able to handle complex things...it just does it with a lot less code.</p>

<p>Consider this Moose code:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Archer</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span><br /><span class="word">extends</span> <span class="single">'Person'</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="word">weapon</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'rw'</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">lazy</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="core">shift</span><span class="operator">-&gt;</span><span class="word">codename</span> <span class="operator">.</span> <span class="double">&quot;'s bow&quot;</span> <span class="structure">}</span><br /><span class="structure">);</span><br /><br /><span class="word">has</span> <span class="word">arrows</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">lazy</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="structure">[</span> <span class="single">'normal'</span><span class="operator">x</span><span class="number">5</span><span class="operator">,</span> <span class="single">'trick'</span><span class="operator">,</span> <span class="single">'explosive'</span> <span class="structure">]</span> <span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>This can we written a lot more succinctly in Mo</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Archer</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mo</span><span class="structure">;</span><br /><span class="word">extends</span> <span class="single">'Person'</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="word">weapon</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="core">shift</span><span class="operator">-&gt;</span><span class="word">codename</span> <span class="operator">.</span> <span class="double">&quot;'s bow&quot;</span> <span class="structure">};</span><br /><span class="word">has</span> <span class="word">arrows</span> <span class="operator">=&gt;</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="word">ro</span> <span class="operator">=&gt;</span> <span class="structure">[</span> <span class="single">'normal'</span><span class="operator">x</span><span class="number">5</span><span class="operator">,</span> <span class="single">'trick'</span><span class="operator">,</span> <span class="single">'explosive'</span> <span class="structure">];</span></code><br />&nbsp;</td></table>

<p>Three key things make this code quicker to write:</p>

<dl>

<dt>Everything is lazy by default. This means that the accessor values aren&#39;t populated until they&#39;re accessed the first time. To force something to be non-lazy with Mo, you explicitly have to use <code>&lt;lazy =</code> 0&gt;&gt;.</dt>
<dd>

</dd>
<dt>The default keyword is completely optional. If Mo sees a subroutine reference it assumes it&#39;s the default subroutine.</dt>
<dd>

</dd>
<dt>Array references and hash references are assumed to be templates that need to be shallow copied. So <code>[1,2,3]</code> is the same as <code>lazy =&gt; 1, default =&gt; sub { [1,2,3] }</code> in Moose. (Deep hash / arrays still require more traditional syntax however!)</dt>
<dd>

</dd>
</dl>

<h3 id="Speed">Speed</h3>

<p>Okay, so it&#39;s quicker to write...but what about quicker to run, and more importantly, quicker to start up.</p>

<p>Let&#39;s see what the timings are for our above script by benchmarking it on one of Microsoft&#39;s Standard Linux 4 core 8GB instances. I&#39;ve prepared three versions of the script for testing, each using either Moose, Moo or Mo.</p>

<pre><code>    $ time perl moose.pl &gt;/dev/null
    real    0m0.183s
    user    0m0.163s
    sys     0m0.020s
    
    $ time perl moo.pl &gt;/dev/null
    real    0m0.036s
    user    0m0.020s
    sys     0m0.016s
    
    $ time perl mo.pl &gt;/dev/null
    real    0m0.006s
    user    0m0.006s
    sys     0m0.000s</code></pre>

<p>We can see that just as Moo is faster than Moose an order of magnitude, Mo is fast by an order of magnitude again. To put this in some real world scenario, the Mo code is so fast that we could execute it every single frame of a 60Hz television video playback. The Moose version barely gets the five frames a second of the worst possible animated gif.</p>

<h3 id="Memory">Memory</h3>

<p>Speed isn&#39;t everything. What about memory usage?</p>

<pre><code>    $ /usr/bin/time -f &#39;%MK&#39; perl moose.pl &gt;/dev/null
    20200K
    $ /usr/bin/time -f &#39;%MK&#39; perl moo.pl &gt;/dev/null
    8372K
    $ /usr/bin/time -f &#39;%MK&#39; perl mo.pl &gt;/dev/null
    4668K</code></pre>

<p>Whoa, that&#39;s a big difference. We should also consider that the baseline Perl interpreter takes up the majority of the memory:</p>

<pre><code>    /usr/bin/time -f &#39;%MK&#39; perl -e 1 &gt;/dev/null
    4144K</code></pre>

<h3 id="Portability">Portability</h3>

<p>In order to install Moose and its dependencies you need a working compiler. Moo is much easier to install - it&#39;s a pure Perl solution, though still has several classes and its own distribution on the CPAN that you&#39;ll need to run any Moo code. Mo? Mo is designed to be bundled with your application.</p>

<p>It&#39;s common to see a custom versions of Mo bundled with other modules within their distribution. Instead of using the CPAN version of Mo:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Spline::Reticulator</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mo</span><span class="structure">;</span><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>They rely on their own version that the include in the distribution itself</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Spline::Reticulator::Mo</span><span class="structure">;</span><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>The version of Mo that is distribution is often a cut down selection of the Mo source code providing just what the project needs and no more. Mo ships with a tool <code>Mo::Inline</code> that makes producing these modules trivial.</p>

<p>First, write a dummy package shim explaining what parts of Mo you&#39;d like included</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Spline::Reticulator::Mo</span><span class="structure">;</span><br /><span class="comment"># use Mo qw'build builder default import';<br /></span><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Then run the <code>mo-inline</code> script to expand the code:</p>

<pre><code>  $ mo-inline .
  Mo Inlined ./lib/Spline/Reticulator/Mo.pm</code></pre>

<p>If you were to poke inside the class now you&#39;d see it contains a single line optomised version of Mo, just like one of the <a href="https://fastapi.metacpan.org/source/ANPARKER/MikroTik-Client-v0.520/lib/MikroTik/Client/Mo.pm">many examples on the CPAN</a>.</p>

<p>It&#39;s even possible to completely inline Mo inside a script by including the inlined code directly in the script:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">package</span> <span class="word">My::Mo</span><span class="structure">;</span><br /><span class="keyword">BEGIN</span> <span class="structure">{</span> <span class="symbol">$INC</span><span class="structure">{</span><span class="single">'My/Mo.pm'</span><span class="structure">}</span><span class="operator">=</span><span class="word">__FILE__</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="keyword">no</span> <span class="pragma">warnings</span><span class="structure">;</span><span class="keyword">my</span><span class="symbol">$M</span><span class="operator">=</span><span class="word">__PACKAGE__</span><span class="operator">.</span><span class="single">'::'</span><span class="structure">;</span><span class="cast">*</span><span class="structure">{</span><span class="symbol">$M</span><span class="operator">.</span><span class="word">Objec</span><span class="operator">...&lt;</span><span class="word">snip</span><span class="operator">&gt;</span><br /><span class="structure">}</span><br /><br /><span class="word">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><br /><span class="keyword">package</span> <span class="word">Person</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">My::Mo</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'name'</span><span class="structure">;</span><br /><span class="word">has</span> <span class="single">'codename'</span><span class="structure">;</span><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<p>By wrapping the inline code inside a <code>BEGIN { ... }</code> (to make sure that the code is executed before the code below it is parsed) and by introducing <code>$INC{&#39;My/Mo.pm&#39;}=__FILE__</code> (which prevents perl from actually searching on disk for a file called <code>My/Mo.pm</code>) we can create a <code>My::Mo</code> class we can use in the script whenever we want to enable Mo.</p>

<h3 id="A-Victory-FSVO-Victory">A Victory, FSVO Victory...</h3>

<p>&quot;Okay...Okay!&quot;, Currant Northwick begrudgingly agreed, &quot;I&#39;ll rewrite this code with Mo. But you do realize you&#39;re going to have to code review it again from scratch, right?&quot;</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="The Weather Outside Is Frightful" href="2019-12-06.html">Previous</a></li>

    <li class="next"><a title="Christmas Movie Time!" href="2019-12-08.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





