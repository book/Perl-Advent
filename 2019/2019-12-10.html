<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Awaiting Christmas

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Awaiting Christmas</h1>
<div class='subtitle'>Mojo::AsyncAwait - 2019-12-10</div>

<div class='pod'><p>Fir Cidergift was working on a new project at the North Pole to monitor world events. If there anything - anything at all - that was going on in the world that could impact Christmas deliveries, the elves need to know about it right away.</p>

<h3 id="A-Blocking-Solution">A Blocking Solution</h3>

<p>Fir&#39;s prototype was a simple single process web server that would go off and scrape news sites and render them on one page. The current version only scraped the top story on Slate, but it was a good start for a morning&#39;s work. Not only had Fir got the scraping working, but he&#39;d also made a stab at a simple caching mechanism that cached the rendered output for thirty seconds to prevent the troops of elves at the North Pole from overloading their internet connection as they refeshed every few seconds.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Mojolicious::Lite</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">update_cache</span> <span class="prototype">($c)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span> <span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="word">time</span> <span class="operator">&lt;</span> <span class="symbol">$time_to_update</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="word">time</span> <span class="operator">+</span> <span class="number">30</span><span class="structure">;</span><br /><br /><span class="comment">    # get the home page of Slate<br /></span>    <span class="keyword">my</span> <span class="symbol">$homepage</span> <span class="operator">=</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="single">'https://slate.com/'</span><span class="structure">);</span><br /><br /><span class="comment">    # grab the url for the big headline<br /></span>    <span class="keyword">my</span> <span class="symbol">$url</span> <span class="operator">=</span>  <span class="symbol">$homepage</span><span class="operator">-&gt;</span><span class="word">res</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">dom</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.story-card__headline'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'href'</span><span class="structure">);</span><br /><br /><span class="comment">    # get the actual article<br /></span>    <span class="keyword">my</span> <span class="symbol">$article</span> <span class="operator">=</span> <span class="word">app</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="symbol">$url</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$dom</span> <span class="operator">=</span> <span class="symbol">$article</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">dom</span><span class="structure">;</span><br /><br /><span class="comment">    # render our homepage to a static file where we can have<br />&nbsp;&nbsp;&nbsp;&nbsp;# mojo serve as needed<br /></span>    <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'home.html'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">render_to_string</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'template'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">headline</span>   <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__hed'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sub_header</span> <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__dek'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br /><span class="comment">    # cache the main picture from the article into the 'public' dir<br />&nbsp;&nbsp;&nbsp;&nbsp;# where mojo will directly serve static files from<br /></span>    <span class="keyword">my</span> <span class="symbol">$picture_url</span> <span class="operator">=</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.image__src'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'data-normal'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$picture</span> <span class="operator">=</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="symbol">$picture_url</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'image.jpg'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span> <span class="symbol">$picture</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">body</span> <span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="comment"># if someone gets '/' just spit out the static home.html file,<br /># updating it if need be first<br /></span><span class="word">get</span> <span class="single">'/'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($c)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">update_cache</span><span class="structure">(</span><span class="symbol">$c</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">reply</span><span class="operator">-&gt;</span><span class="word">static</span><span class="structure">(</span><span class="single">'home.html'</span><span class="structure">);</span><br /><span class="structure">};</span><br /><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">start</span><span class="structure">;</span><br /><br /><span class="separator">__DATA__</span><br /><span class="data"><br />@@ template.html.ep<br />&lt;html&gt;<br />&lt;body&gt;<br />&lt;h1&gt;&lt;%= $headline %&gt;&lt;/h1&gt;<br />&lt;p&gt;&lt;%= $sub_header %&gt;&lt;/p&gt;<br />&lt;img src=&quot;image.jpg&quot;&gt;<br />&lt;/html&gt;</span></code><br />&nbsp;</td></table>

<p>&quot;It&#39;s looking good&quot;, the Wise Old Elf commented. &quot;But every thirty seconds things are going to get bad for the users. The unlucky elf that hit the page is going to have to sit there while all the websites are scraped. Also, anyone else that comes along isn&#39;t going to get a page either - our webserver is single threaded and the thread is busy waiting around for webpages to come back to it over the internet, not serving data.&quot;</p>

<h3 id="Callbacks">Callbacks</h3>

<p>What Fir needed to do was change his code so that the end user always immediately be delivered the cached version of the page. If the cache was out of date then Mojolicious should start to scrape a new version in the background ready for the next elf that came along while at the same time in the foreground serving the older version to the current elf immediately. No more waiting for impatient elves!</p>

<p>Fir read the documentation for Mojolicious and discovered that <a href="https://metacpan.org/module/Mojo::UserAgent">Mojo::UserAgent</a> doesn&#39;t have to block and return the scraped web page, but instead you can pass it a callback that will be executed when it&#39;s done fetching data. A quick rewrite later and the <code>update_cache</code> function now looked like this:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">update_cache</span><span class="prototype">($c)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span> <span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="word">time</span> <span class="operator">&lt;</span> <span class="symbol">$time_to_update</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="word">time</span> <span class="operator">+</span> <span class="number">30</span><span class="structure">;</span><br /><br /><span class="comment">    # get the home page of Slate<br /></span>    <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="single">'https://slate.com/'</span><span class="operator">,</span> <span class="keyword">sub</span> <span class="prototype">($, $homepage)</span> <span class="structure">{</span><br /><span class="comment">        # grab the url for the big headline<br /></span>        <span class="keyword">my</span> <span class="symbol">$url</span> <span class="operator">=</span>  <span class="symbol">$homepage</span><span class="operator">-&gt;</span><span class="word">res</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">dom</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.story-card__headline'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'href'</span><span class="structure">);</span><br /><br /><span class="comment">        # get the actual article<br /></span>        <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="symbol">$url</span><span class="operator">,</span> <span class="keyword">sub</span> <span class="prototype">($, $article)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$dom</span> <span class="operator">=</span> <span class="symbol">$article</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">dom</span><span class="structure">;</span><br /><br /><span class="comment">            # render our homepage to a static file where we can have<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# mojo serve as needed<br /></span>            <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'home.html'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">render_to_string</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'template'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">headline</span>   <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__hed'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sub_header</span> <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__dek'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br /><span class="comment">            # cache the main picture from the article into the 'public' dir<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# where mojo will directly serve static files from<br /></span>            <span class="keyword">my</span> <span class="symbol">$picture_url</span> <span class="operator">=</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.image__src'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'data-normal'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="symbol">$picture_url</span><span class="operator">,</span> <span class="keyword">sub</span> <span class="prototype">($, $picture)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'image.jpg'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span> <span class="symbol">$picture</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">body</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>The trouble was that the code had got decidedly harder to follow. Each network request resulted in another callback being scheduled from the parent callback. By the time that the callback for downloading the graphic which was called from the callback for downloading the article which was called from the callback for downloading the homepage was called, things were getting pretty deep - and the amount of indenting was getting out of control.</p>

<h3 id="Promises">Promises</h3>

<p>It was time to take a different approach. Fir remembered an article on <a href="https://metacpan.org/module/Mojo::Promise">Mojo::Promise</a> from <a href="http://www.perladvent.org/2018/2018-12-19.html">last year&#39;s advent calendar</a>. Could using promises help with the crazy indenting?</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">update_cache</span><span class="prototype">($c)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span> <span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="word">time</span> <span class="operator">&lt;</span> <span class="symbol">$time_to_update</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="word">time</span> <span class="operator">+</span> <span class="number">30</span><span class="structure">;</span><br /><br /><span class="comment">    # get the home page of Slate<br /></span>    <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><span class="single">'https://slate.com/'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span><span class="keyword">sub</span> <span class="prototype">($homepage, @)</span> <span class="structure">{</span><br /><span class="comment">        # grab the url for the big headline<br /></span>        <span class="keyword">my</span> <span class="symbol">$url</span> <span class="operator">=</span>  <span class="symbol">$homepage</span><span class="operator">-&gt;</span><span class="word">res</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">dom</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.story-card__headline'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'href'</span><span class="structure">);</span><br /><br /><span class="comment">        # get the actual article<br /></span>        <span class="keyword">return</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><span class="symbol">$url</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">})</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span> <span class="keyword">sub</span> <span class="prototype">($article, @)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$dom</span> <span class="operator">=</span> <span class="symbol">$article</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">dom</span><span class="structure">;</span><br /><br /><span class="comment">        # render our homepage to a static file where we can have<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# mojo serve as needed<br /></span>        <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'home.html'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">render_to_string</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'template'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">headline</span>   <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__hed'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sub_header</span> <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__dek'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br /><span class="comment">        # get the main picture<br /></span>        <span class="keyword">my</span> <span class="symbol">$picture_url</span> <span class="operator">=</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.image__src'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'data-normal'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><span class="symbol">$picture_url</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">})</span><span class="operator">-&gt;</span><span class="word">then</span><span class="structure">(</span> <span class="keyword">sub</span> <span class="prototype">($picture, @)</span> <span class="structure">{</span><br /><span class="comment">        # cache the main picture from the article into the 'public' dir<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# where mojo will directly serve static files from<br /></span>        <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'image.jpg'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span> <span class="symbol">$picture</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">body</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now Fir had a pattern of the <code>then</code> subroutines being called whenever the previous promise was resolved. No more indenting!</p>

<p>Personally however, I don&#39;t find this much more readable than the callback code. Explicit promises are powerful things when you&#39;re passing them around your code, but when control is just flowing from the top of the page to the bottom as it is here they can add a lot of extra code that is distracting. It&#39;s also adding a whole bunch of extra scopes which make it harder to access variables from the top of your code in the bottom and can easily make the code very torturous to write - the cure is worse than the disease.</p>

<h3 id="Async-and-Await">Async and Await</h3>

<p>What we need is Perl to be a little more like JavaScript. JavaScript has an await keyword that can tell the interpreter to stop and wait for a promise to be fulfilled before continuing (just like <code>$promise-&gt;wait</code> does) but <b>also</b> allow other code to run at that point. This typically isn&#39;t something we can add to a language without making changes to the interpret itself - after all you need the ability to hop out of the subroutine and then later jump right back into the middle of the subroutine where you left off.</p>

<p>Luckily, Fir hadn&#39;t just been reading the Perl Advent Calendar last year, he&#39;d also read the Mojolicious Advent Calendar&#39;s <a href="https://mojolicious.io/blog/2018/12/24/async-await-the-mojo-way/">entry</a> on the <a href="https://metacpan.org/module/Mojo::AsyncAwait">Mojo::AsyncAwait</a> module which does &quot;XS and C-level shenanigans&quot; in the Perl interpreter to allow the <code>async</code> and <code>await</code> keywords to suspend and resume execution.</p>

<p>Now Fir could rewrite the <code>update_cache</code> subroutine to run <code>async</code>, and he could use the <code>await</code> keyword to stop and await the promises (while executing other code while it waits!)</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">async</span> <span class="word">update_cache</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($c)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span> <span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="word">time</span> <span class="operator">&lt;</span> <span class="symbol">$time_to_update</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$time_to_update</span> <span class="operator">=</span> <span class="word">time</span> <span class="operator">+</span> <span class="number">30</span><span class="structure">;</span><br /><br /><span class="comment">    # get the home page of Slate<br /></span>    <span class="keyword">my</span> <span class="symbol">$homepage</span> <span class="operator">=</span> <span class="word">await</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><span class="single">'https://slate.com/'</span><span class="structure">);</span><br /><br /><span class="comment">    # grab the url for the big headline<br /></span>    <span class="keyword">my</span> <span class="symbol">$url</span> <span class="operator">=</span>  <span class="symbol">$homepage</span><span class="operator">-&gt;</span><span class="word">res</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">dom</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.story-card__headline'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'href'</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$article</span> <span class="operator">=</span> <span class="word">await</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><span class="symbol">$url</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$dom</span> <span class="operator">=</span> <span class="symbol">$article</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">dom</span><span class="structure">;</span><br /><br /><span class="comment">    # render our homepage to a static file where we can have<br />&nbsp;&nbsp;&nbsp;&nbsp;# mojo serve as needed<br /></span>    <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'home.html'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">render_to_string</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'template'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">headline</span>   <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__hed'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sub_header</span> <span class="operator">=&gt;</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.article__dek'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br /><span class="comment">    # get the main picture<br /></span>    <span class="keyword">my</span> <span class="symbol">$picture_url</span> <span class="operator">=</span> <span class="symbol">$dom</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="single">'.image__src'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">attr</span><span class="structure">(</span><span class="single">'data-normal'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$picture</span> <span class="operator">=</span> <span class="word">await</span> <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">ua</span><span class="operator">-&gt;</span><span class="word">get_p</span><span class="structure">(</span><span class="symbol">$picture_url</span><span class="structure">);</span><br /><br /><span class="comment">    # cache the main picture from the article into the 'public' dir<br />&nbsp;&nbsp;&nbsp;&nbsp;# where mojo will directly serve static files from<br /></span>    <span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">home</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">(</span><span class="single">'public'</span><span class="operator">,</span><span class="single">'image.jpg'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">spurt</span><span class="structure">(</span> <span class="symbol">$picture</span><span class="operator">-&gt;</span><span class="word">res</span><span class="operator">-&gt;</span><span class="word">body</span> <span class="structure">);</span><br /><br /><span class="structure">};</span></code><br />&nbsp;</td></table>

<p>This code looks identical to the original blocking code that Fir started out with, apart from the introduction of the <code>async</code> keyword to declare the <code>update_cache</code> subroutine and the use of <code>await $c-&gt;ua-&gt;get_p(...)</code> instead of <code>$c-&gt;ua-&gt;get(...)</code>.</p>

<p>The behavior however is completely different - the subroutine stops executing as soon as it hits that first await and switches back to the caller, delivering the cached page while network requests continue in the background.</p>

<p>Nice. Now all he had to do was add scraping logic for another thirty or so websites and he&#39;d have something awesome to show at standup tomorrow morning.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Command Line Browser Apps" href="2019-12-09.html">Previous</a></li>

    <li class="next"><a title="Now With Added Interactivity" href="2019-12-11.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





