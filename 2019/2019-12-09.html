<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Command Line Browser Apps

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Command Line Browser Apps</h1>
<div class='subtitle'>Net::EmptyPort - 2019-12-09</div>

<div class='pod'><p><script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1/dist/chart.xkcd.min.js"></script> <svg class="chart"></svg> <script> const chartElement = document.querySelector('.chart'); const lineChart = new chartXkcd.Line( chartElement, { title: "Thousands Of Toys Produced", xLabel: "Week", data: {"datasets":[{"data":["36","43","65","77","115","129","143","157","182","196","225","245","258","270","302","327","329","349","369","392","417","427","443","472","499","511","527","543","562","578","607","627","642","660","677","703","719","743","752","780","788","809"],"label":"Electronics"},{"data":["92","136","214","227","267","303","307","328","340","376","360","380","398","392","390","393","393","405","390","391","404","412","409","399","432","423","397","431","403","409","406","426","434","423","433","436","424","435","436","431","421","424"],"label":"Classic"},{"data":["98","139","145","162","187","130","164","161","197","231","236","244","288","341","337","348","407","438","429","401","500","448","475","569","500","524","571","559","639","657","614","631","671","757","775","778","776","826","760","788","865","897"],"label":"Transport"},{"data":["609","446","592","546","511","441","497","544","420","604","606","427","600","603","507","485","422","518","548","516","436","594","425","573","486","601","436","590","460","603","518","475","589","539","436","605","454","541","576","503","434","467"],"label":"Soft"},{"data":["1073","1123","1145","1033","1175","912","918","1085","986","949","1009","925","951","1074","1007","1080","911","903","1089","1080","1003","1150","1111","936","951","1133","1131","1167","1088","1176","965","922","1151","1068","1078","1173","973","1044","1023","952","1116","965"],"label":"Candy"},{"data":["0","0","0","0","0","0","0","0","0","0","5","100","121","212","232","234","242","256","278","300","412","812","900","901","906","904","961","980","456","0","0","0","43","981","990","1023","1203","1501","1988","2012","2024","2054"],"label":"Novelty"}],"labels":["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42"]}, options: { yTickCount: 3, legendPosition: chartXkcd.config.positionType.upLeft } } ); </script>

</p>



<p>The weeks leading up to Christmas is a stressful time for most elves at the North Pole. Not so for Buster Stripytights. No...<i>every</i> week was stressful for him.</p>

<p>You see, Buster&#39;s job is nothing short of making sure that enough toys are produced throughout the year. Every week it&#39;s his job to compute how production is going, if they were ahead or behind schedule, and if Santa was going to have enough toys to make every good child happy, or if it was going to be a disaster this year. It hasn&#39;t happened yet, but it&#39;s only thanks to the diligent work of Mr Stripytights that any issue has been detected and dealt with before it became a real problem.</p>

<p>As you can imagine, this involves a lot of number crunching and What-If type predictions. Most importantly, it involves a lot of quick data visualization.</p>

<p>A few years ago Buster had despaired about getting the kind of interactive output he needed from his Perl data crunching scripts. That was before the Wise Old Elf had stepped in.</p>

<h3 id="The-Plan">The Plan</h3>

<p>Some people like to wield the terminal. Others like to have an interactive web page to control things.</p>

<p>However, the Wise Old Elf is...wise. He likes the best of both worlds: Being able to jump from the command line into the browser and then quickly back to the terminal again, and onto the next command.</p>

<p>For the task Buster needed he suggested making a script to immediately display the output of crunching the data in a web browser.</p>

<p>When the script was executed from the terminal the Perl script should:</p>

<p><ul> <li>Do the initial processing of data</li> <li>Finds a random unused port on localhost</li> <li>Open a web server on that unused port</li> <li>Open the browser to point at that port</li> <li>Finally when the browser window is closed, quit the script</li> </ul>

</p>



<p>Simple! Let&#39;s break down how to do that!</p>

<h3 id="The-Start-of-our-Web-Application">The Start of our Web Application</h3>

<p>Using a web server to pass the output to the browser has several advantages over writing out temporary files. We don&#39;t have to figure out a way to periodically clear up those files. We can pause execution of subsequent commands in the terminal till the browser window is closed. We can control all files the browser has to load. And we have the full potential to pass information back and forward to Perl as the user interacts with the contents of the browser window.</p>

<p>The start of our interactive tool is a <a href="https://metacpan.org/module/Mojolicious">Mojolicious</a> web app (using the <a href="https://metacpan.org/module/Mojolicious::Lite">Mojolicious::Lite</a> framework).</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Mojolicious::Lite</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="word">get</span> <span class="single">'/'</span> <span class="operator">=&gt;</span> <span class="single">'index'</span><span class="structure">;</span><br /><br /><span class="keyword">our</span> <span class="symbol">$message</span> <span class="operator">=</span> <span class="double">&quot;Merry Christmas from the script!&quot;</span><span class="structure">;</span><br /><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">start</span><span class="structure">(</span><span class="single">'daemon'</span><span class="structure">);</span><br /><br /><span class="separator">__DATA__</span><br /><span class="data">@@ index.html.ep<br />&lt;html&gt;<br />&lt;body&gt;<br />&lt;%= $main::message %&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;</span></code><br />&nbsp;</td></table>

<p>Running the script shows it starts up a server on the</p>

<pre><code>    $ ./script.pl
    [2019-11-23 10:20:42.21211] [19502] [info] Listening at &quot;http://*:3000&quot;</code></pre>

<p>We defined just one route (<code>/</code>) that renders the <code>index</code> template in the <code>DATA</code> section, which will dynamically include data from our Perl code.</p>

<h3 id="Picking-a-Random-Port">Picking a Random Port</h3>

<p>At the moment our server will always open on the standard Mojolicious development port, port 3000. But Buster needs to be able to display more than one graph on the screen at any one time! Each of these servers are going to have to pick their own port to run on.</p>

<p>This is actually quite simple with the help of the <a href="https://metacpan.org/module/Net::EmptyPort">Net::EmptyPort</a> module which can find a random port that nothing else is using for us:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Net::EmptyPort</span> <span class="words">qw( empty_port )</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$base_url</span> <span class="operator">=</span> <span class="single">'http://127.0.0.1:'</span> <span class="operator">.</span> <span class="word">empty_port</span><span class="structure">();</span><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">start</span><span class="structure">(</span><span class="single">'daemon'</span><span class="operator">,</span><span class="single">'--listen'</span><span class="operator">,</span> <span class="symbol">$base_url</span> <span class="structure">);</span></code><br />&nbsp;</td></table>

<h3 id="Opening-The-Page-Automatically">Opening The Page Automatically</h3>

<p>To make this more like an &quot;app&quot; we don&#39;t want Buster to have to copy any paste the URL from the terminal into his browser after the program starts up. We want the web page just to immediately open up as soon as the script is ready to display something to the user.</p>

<p>This can be achieved by hooking the <code>before_server_start</code> Mojolicious event. We&#39;ll have it call the <code>open_browser</code> function from the ever-so-handy <a href="https://metacpan.org/module/Browser::Open">Browser::Open</a> module as soon as Mojolcious is ready to serve web pages.</p>

<p>While we&#39;re at it we don&#39;t need Mojolicious to print URLs or debug information out to the console anymore, so we suppress all of that:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Mojolicious::Lite</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Net::EmptyPort</span> <span class="words">qw( empty_port )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Browser::Open</span> <span class="words">qw( open_browser )</span><span class="structure">;</span><br /><br /><span class="word">get</span> <span class="single">'/'</span> <span class="operator">=&gt;</span> <span class="single">'index'</span><span class="structure">;</span><br /><br /><span class="comment"># stop logging out when we visit URLs<br /></span><span class="word">app</span><span class="operator">-&gt;</span><span class="word">log</span><span class="operator">-&gt;</span><span class="word">level</span><span class="structure">(</span><span class="single">'warn'</span><span class="structure">);</span><br /><br /><span class="comment"># open the browser as soon as we start<br /></span><span class="keyword">my</span> <span class="symbol">$base_url</span> <span class="operator">=</span> <span class="single">'http://127.0.0.1:'</span> <span class="operator">.</span> <span class="word">empty_port</span><span class="structure">();</span><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">hook</span><span class="structure">(</span><span class="word">before_server_start</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($server, @)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$server</span><span class="operator">-&gt;</span><span class="word">silent</span><span class="structure">(</span><span class="number">1</span><span class="structure">);</span>  <span class="comment"># don't display &quot;Server available...&quot;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">open_browser</span><span class="structure">(</span><span class="symbol">$base_url</span><span class="structure">);</span><br /><span class="structure">});</span><br /><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">start</span><span class="structure">(</span><span class="single">'daemon'</span><span class="operator">,</span><span class="single">'--listen'</span><span class="operator">,</span> <span class="symbol">$base_url</span> <span class="structure">);</span><br /><span class="operator">...</span></code><br />&nbsp;</td></table>

<h3 id="Quitting-Time">Quitting Time</h3>

<p>To make this like a real application we don&#39;t want Buster to have to remember to head back to the terminal and ctrl-C the command line program when he&#39;s done with the graph. There must be some way to automatically quit the script as soon as the browser window closes!</p>

<p>We can hook the <code>unload</code> event in JavaScript fairly easily:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">window</span>.addEventListener( <span class="synConstant">&quot;unload&quot;</span>, ... );</code><br />&nbsp;</td></table>

<p>But what should we have that do? Ideally we&#39;d like to send a HTTP request back to the browser, but doing this via AJAX is unreliable: The page might complete closing before the asynchronous web request gets far enough along. Never fear! We&#39;re running a faily modern web browser, so we can make use of <i>beacons</i>.</p>

<p>The Beacon API is a fire-and-forget non-blocking way to tell the browser to make a HTTP POST request <i>as soon as it is able to</i> and we don&#39;t care about the result. This means we can make a simple call like so:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>navigator.sendBeacon(<span class="synConstant">&quot;/exit&quot;</span>)</code><br />&nbsp;</td></table>

<p>And the browser will continue to make the call to our backend even after its closed the window with our webpage in it.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Mojolicious::Lite</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="operator">...</span><br /><br /><span class="word">get</span> <span class="single">'/'</span> <span class="operator">=&gt;</span> <span class="single">'index'</span><span class="structure">;</span><br /><br /><span class="comment"># when our beacon notifies us, just quit right away<br /></span><span class="word">post</span> <span class="single">'/exit'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">exit</span> <span class="structure">};</span><br /><br /><span class="operator">...</span><br /><br /><span class="separator">__DATA__</span><br /><span class="data">@@ index.html.ep<br />&lt;html&gt;<br />&lt;script&gt;<br />// when the page is closed have the browser send a POST<br />// to /exit to tell Mojolicious to shut down<br />window.addEventListener(<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;unload&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;() =&gt; navigator.sendBeacon(&quot;/exit&quot;),<br />&nbsp;&nbsp;&nbsp;&nbsp;false<br />);<br />&lt;/script&gt;<br />&lt;body&gt;<br />&lt;%= $main::message %&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;</span></code><br />&nbsp;</td></table>

<h3 id="Putting-It-All-Together">Putting It All Together</h3>

<p>Now we can put all of this together into building a script that dynamically shows any CSV as a graph:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;<br />65:&nbsp;<br />66:&nbsp;<br />67:&nbsp;<br />68:&nbsp;<br />69:&nbsp;<br />70:&nbsp;<br />71:&nbsp;<br />72:&nbsp;<br />73:&nbsp;<br />74:&nbsp;<br />75:&nbsp;<br />76:&nbsp;<br />77:&nbsp;<br />78:&nbsp;<br />79:&nbsp;<br />80:&nbsp;<br />81:&nbsp;<br />82:&nbsp;<br />83:&nbsp;<br />84:&nbsp;<br />85:&nbsp;<br />86:&nbsp;<br />87:&nbsp;<br />88:&nbsp;<br />89:&nbsp;<br />90:&nbsp;<br />91:&nbsp;<br />92:&nbsp;<br />93:&nbsp;<br />94:&nbsp;<br />95:&nbsp;<br />96:&nbsp;<br />97:&nbsp;<br />98:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="word">Mojolicious::Lite</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Net::EmptyPort</span> <span class="words">qw( empty_port )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Browser::Open</span> <span class="words">qw( open_browser )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Text::CSV_XS</span> <span class="structure">();</span><br /><br /><span class="comment">##########################################################<br /></span><br /><span class="keyword">my</span> <span class="symbol">$filename</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$csv</span> <span class="operator">=</span> <span class="word">Text::CSV_XS</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">({</span> <span class="word">binary</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span> <span class="word">auto_diag</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">});</span><br /><span class="word">open</span> <span class="word">my</span> <span class="symbol">$fh</span><span class="operator">,</span> <span class="double">&quot;&lt;:encoding(utf8)&quot;</span><span class="operator">,</span> <span class="symbol">$filename</span> <span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;$filename: $!&quot;</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$data</span> <span class="operator">=</span> <span class="structure">{};</span><br /><span class="keyword">my</span> <span class="symbol">$titles</span> <span class="operator">=</span> <span class="symbol">$csv</span><span class="operator">-&gt;</span><span class="word">getline</span><span class="structure">(</span><span class="symbol">$fh</span><span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$xlabel</span> <span class="operator">=</span> <span class="core">shift</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$titles</span> <span class="structure">};</span><br /><span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">labels</span><span class="structure">}</span> <span class="operator">=</span> <span class="structure">[];</span><br /><span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">datasets</span><span class="structure">}</span> <span class="operator">=</span> <span class="structure">[</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">map</span> <span class="structure">{</span> <span class="operator">+</span><span class="structure">{</span> <span class="word">label</span> <span class="operator">=&gt;</span> <span class="magic">$_</span><span class="operator">,</span> <span class="word">data</span> <span class="operator">=&gt;</span> <span class="structure">[]</span> <span class="structure">}</span> <span class="structure">}</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$titles</span> <span class="structure">}</span><br /><span class="structure">];</span><br /><br /><span class="keyword">while</span> <span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$row</span> <span class="operator">=</span> <span class="symbol">$csv</span><span class="operator">-&gt;</span><span class="word">getline</span><span class="structure">(</span><span class="symbol">$fh</span><span class="structure">))</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">labels</span><span class="structure">}</span> <span class="structure">}</span><span class="operator">,</span> <span class="core">shift</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$row</span> <span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">datasets</span><span class="structure">}[</span> <span class="magic">$_</span> <span class="structure">]{</span><span class="word">data</span><span class="structure">}</span> <span class="structure">}</span><span class="operator">,</span> <span class="symbol">$row</span><span class="operator">-&gt;</span><span class="structure">[</span> <span class="magic">$_</span> <span class="structure">]</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">for</span> <span class="number">0</span><span class="operator">..</span><span class="structure">(</span><span class="word">scalar</span><span class="structure">(</span><span class="cast">@</span><span class="structure">{</span> <span class="symbol">$row</span> <span class="structure">})</span><span class="number">-1</span><span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="word">close</span> <span class="symbol">$fh</span> <span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;$filename: $!&quot;</span><span class="structure">;</span><br /><br /><span class="comment">##########################################################<br /></span><br /><span class="word">get</span> <span class="single">'/'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($c, @)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$c</span><span class="operator">-&gt;</span><span class="word">render</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'index'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">title</span>  <span class="operator">=&gt;</span> <span class="symbol">$filename</span> <span class="operator">=~</span> <span class="substitute">s/[.]csv$//r</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">xlabel</span> <span class="operator">=&gt;</span> <span class="symbol">$xlabel</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">cols</span>   <span class="operator">=&gt;</span> <span class="symbol">$data</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span><br /><span class="word">post</span> <span class="single">'/exit'</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">exit</span> <span class="structure">};</span><br /><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">log</span><span class="operator">-&gt;</span><span class="word">level</span><span class="structure">(</span><span class="single">'warn'</span><span class="structure">);</span><br /><br /><span class="keyword">my</span> <span class="symbol">$base_url</span> <span class="operator">=</span> <span class="single">'http://127.0.0.1:'</span> <span class="operator">.</span> <span class="word">empty_port</span><span class="structure">();</span><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">hook</span><span class="structure">(</span><span class="word">before_server_start</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($server, @)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$server</span><span class="operator">-&gt;</span><span class="word">silent</span><span class="structure">(</span><span class="number">1</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">open_browser</span><span class="structure">(</span><span class="symbol">$base_url</span><span class="structure">);</span><br /><span class="structure">});</span><br /><br /><span class="word">app</span><span class="operator">-&gt;</span><span class="word">start</span><span class="structure">(</span><span class="single">'daemon'</span><span class="operator">,</span><span class="single">'--listen'</span><span class="operator">,</span> <span class="symbol">$base_url</span> <span class="structure">);</span><br /><br /><span class="separator">__DATA__</span><br /><span class="data">@@ index.html.ep<br />% # This pages includes output directly in the  &lt;script&gt;...&lt;/script&gt;<br />% # tags.  Note that this is only safe because:<br />% <br />% #   (a) I'm using to_json which outputs characters not bytes so<br />% #       when Mojolicious does the final byte encoding everything will<br />% #        work out and not be double encoded, and<br />% <br />% #   (b) Mojo::JSON (unlike many other JSON libraries) *also* escapes<br />% #       any '/' as '\/' meaning that a rogue '&lt;/script&gt;' in the data<br />% #       won't terminate the script tags and present a possible<br />% #       JavaScript injection attack<br />% <br />% use Mojo::JSON qw( to_json );<br />&lt;html&gt;<br />&lt;script&gt;<br />// when the page is closed have the browser send a POST<br />// to /exit to tell Mojolicious to shut down<br />window.addEventListener(<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;unload&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;() =&gt; navigator.sendBeacon(&quot;/exit&quot;),<br />&nbsp;&nbsp;&nbsp;&nbsp;false<br />);<br />&lt;/script&gt;<br />&lt;script src=&quot;https://cdn.jsdelivr.net/npm/chart.xkcd@1.1/dist/chart.xkcd.min.js&quot;&gt;&lt;/script&gt;<br />&lt;body&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;svg class=&quot;chart&quot;&gt;&lt;/svg&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;script&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const chartElement = document.querySelector('.chart');<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const lineChart = new chartXkcd.Line(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chartElement,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title: &lt;%== to_json( $title ) %&gt;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xLabel: &lt;%== to_json( $xlabel ) %&gt;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data: &lt;%== to_json( $cols ) %&gt;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options: {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;legendPosition: chartXkcd.config.positionType.upLeft<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;/script&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;</span></code><br />&nbsp;</td></table>

<p>Of course, we could go further than all of this, making a completely interactive application with Perl and JavaScript passing information back and forward to each other...but that&#39;s a project for another day.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Christmas Movie Time!" href="2019-12-08.html">Previous</a></li>

    <li class="next"><a title="Awaiting Christmas" href="2019-12-10.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





