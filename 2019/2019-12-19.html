<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Memories of Past Lives

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Memories of Past Lives</h1>
<div class='subtitle'>Memoize::Expire - 2019-12-19</div>

<div class='pod'><p>Sometimes, Christmas can be the most stressful time of year. Even at the North Pole, it&#39;s not all gumdrops and candycanes.</p>

<p>Take, for example, one very red faced and obviously upset elf. Jolly Pudding was muttering under his breath at his computer after his code had shown yet another error message and ground to a halt.</p>

<p>&quot;And breath!&quot; the Wise Old Elf consoled, &quot;And tell me what the matter is.&quot;</p>

<p>&quot;Well&quot;, Jolly explained, &quot;I&#39;m writing this quick one off script to produce a report on the toy produced this year. The trouble is that the code keeps failing after about half an hour or so. It&#39;s <i>really</i> annoying to debug.&quot;</p>

<p>&quot;So you need it to run faster so you can debug it quicker?&quot;</p>

<p>&quot;Yes. That&#39;s exactly it! Right now I have sit here, twiddling my thumbs for half an hour each time. What&#39;s worse is by the time it fails again I&#39;ve totally lost the train of thought.&quot;</p>

<p>&quot;What you need to do is cache the results of what you <i>did</i> get to run okay between runs.&quot;, whe Wise Old Elf explained sagely, &quot;Then you&#39;d be able to get to the point where the code breaks instantly&quot;</p>

<p>&quot;Oh, I don&#39;t know...that seems like a lot of work for a one off script.&quot;</p>

<p>&quot;I&#39;ve got the perfect module for you: Memoize&quot;</p>

<p>&quot;Memozie! You can&#39;t be serious!&quot;</p>

<h3 id="A-Blast-from-the-past">A Blast from the past.</h3>

<p>Memoize was originally <a href="http://perladvent.pm.org/2000/18/">featured</a> in the first ever Perl Advent calendar entry twenty years ago, back before there even were articles on each module.</p>

<p>Memoize can be used to cache the results of a function call so if it&#39;s called again with the same arguments the cached version is returned. The classic example is the fibonacci sequence.</p>

<p>Without memoize:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">fib</span><span class="prototype">($n)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="number">1</span> <span class="word">if</span> <span class="symbol">$n</span> <span class="operator">&lt;=</span> <span class="number">2</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">fib</span><span class="structure">(</span><span class="symbol">$n</span><span class="operator">-</span><span class="number">1</span><span class="structure">)</span> <span class="operator">+</span> <span class="word">fib</span><span class="structure">(</span><span class="symbol">$n</span><span class="operator">-</span><span class="number">2</span><span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="word">say</span> <span class="word">fib</span><span class="structure">(</span><span class="number">50</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Running this takes a while to execute:</p>

<pre><code>    $ time perl fib.pl
    102334155

    real    1m6.912s
    user    1m6.872s
    sys     0m0.032s</code></pre>

<p>Now the sam code with Memoize:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Memoize</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">fib</span><span class="prototype">($n)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="number">1</span> <span class="word">if</span> <span class="symbol">$n</span> <span class="operator">&lt;=</span> <span class="number">2</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">fib</span><span class="structure">(</span><span class="symbol">$n</span><span class="operator">-</span><span class="number">1</span><span class="structure">)</span> <span class="operator">+</span> <span class="word">fib</span><span class="structure">(</span><span class="symbol">$n</span><span class="operator">-</span><span class="number">2</span><span class="structure">);</span><br /><span class="structure">}</span><br /><span class="word">memoize</span><span class="structure">(</span><span class="single">'fib'</span><span class="structure">);</span><br /><br /><span class="word">say</span> <span class="word">fib</span><span class="structure">(</span><span class="number">50</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Runs much, much faster</p>

<pre><code>    $ time perl fib.pl
    102334155

    real    0m0.055s
    user    0m0.009s
    sys     0m0.009s</code></pre>

<h3 id="Persisting-between-program-runs">Persisting between program runs</h3>

<p>This is all very well, but Memoize uses an <i>in memory</i> cache. Jolly&#39;s problem is that each time he runs his code his program has to re-do all the work up until the point that it crashes. Using memoize like above won&#39;t speed up his code at all as every time the script runs it starts with a fresh empty cache.</p>

<p>What we need to do is what the Wise Old Elf suggested - persist our results between program runs.</p>

<p>Well, Memoize can do that:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">divide</span><span class="prototype">($n,$d)</span> <span class="structure">{</span><br /><span class="comment">    # make this take artificially long for the purposes of<br />&nbsp;&nbsp;&nbsp;&nbsp;# the demo<br /></span>    <span class="word">sleep</span> <span class="number">1</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$n</span> <span class="operator">/</span> <span class="symbol">$d</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="keyword">use</span> <span class="word">DB_File</span><span class="structure">;</span><br /><span class="word">tie</span> <span class="word">my</span> <span class="symbol">%cache</span> <span class="operator">=&gt;</span> <span class="single">'DB_File'</span><span class="operator">,</span> <span class="single">'/tmp/memoize'</span><span class="operator">,</span> <span class="word">O_RDWR</span><span class="operator">|</span><span class="word">O_CREAT</span><span class="operator">,</span> <span class="octal">0666</span><span class="structure">;</span><br /><span class="word">memoize</span> <span class="single">'divide'</span><span class="operator">,</span> <span class="word">SCALAR_CACHE</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="word">HASH</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">%cache</span><span class="structure">];</span><br /><br /><span class="keyword">for</span> <span class="structure">(</span><span class="number">10</span><span class="operator">..</span><span class="number">-10</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">say</span> <span class="double">&quot;100 divided by $_ is &quot;</span> <span class="operator">.</span> <span class="word">divide</span><span class="structure">(</span><span class="number">100</span><span class="operator">,</span><span class="magic">$_</span><span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now the first time we run this it takes a while:</p>

<pre><code>    $time perl div.pl 
    100 divided by -10 is -10
    100 divided by -9 is -11.1111111111111
    100 divided by -8 is -12.5
    100 divided by -7 is -14.2857142857143
    100 divided by -6 is -16.6666666666667
    100 divided by -5 is -20
    100 divided by -4 is -25
    100 divided by -3 is -33.3333333333333
    100 divided by -2 is -50
    100 divided by -1 is -100
    Illegal division by zero at div.pl line 15.

    real    0m11.051s
    user    0m0.031s
    sys     0m0.004s</code></pre>

<p>But the next time is much much quicker:</p>

<pre><code>    $ time perl div.pl 
    100 divided by -10 is -10
    100 divided by -9 is -11.1111111111111
    100 divided by -8 is -12.5
    100 divided by -7 is -14.2857142857143
    100 divided by -6 is -16.6666666666667
    100 divided by -5 is -20
    100 divided by -4 is -25
    100 divided by -3 is -33.3333333333333
    100 divided by -2 is -50
    100 divided by -1 is -100
    Illegal division by zero at div.pl line 15.

    real    0m1.028s
    user    0m0.016s
    sys     0m0.012s</code></pre>

<p>Whooo! instant death!</p>

<h3 id="Methods">Methods</h3>

<p>What if the thing we need to cache is a method call?</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Fetcher</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mo</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">HTTP::Tiny</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="single">'url'</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">fetch</span> <span class="prototype">($self)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$response</span> <span class="operator">=</span> <span class="word">HTTP::Tiny</span><span class="operator">-&gt;</span><span class="word">new</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">url</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">die</span> <span class="double">&quot;Failed!\n&quot;</span> <span class="word">unless</span> <span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">success</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">content</span><span class="structure">};</span><br /><span class="structure">}</span><br /><br /><span class="keyword">use</span> <span class="word">Memoize</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">DB_File</span><span class="structure">;</span><br /><span class="word">tie</span> <span class="word">my</span> <span class="symbol">%cache</span> <span class="operator">=&gt;</span> <span class="single">'DB_File'</span><span class="operator">,</span> <span class="single">'/tmp/memoize'</span><span class="operator">,</span> <span class="word">O_RDWR</span><span class="operator">|</span><span class="word">O_CREAT</span><span class="operator">,</span> <span class="octal">0666</span><span class="structure">;</span><br /><span class="word">memoize</span> <span class="single">'fetch'</span><span class="operator">,</span> <span class="word">SCALAR_CACHE</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="word">HASH</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">%cache</span><span class="structure">];</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Each time we run our Santa detecting script:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Fetcher</span><span class="structure">;</span><br /><br /><span class="keyword">for</span> <span class="structure">(</span><span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;http://www.bbc.co.uk/news/<br />&nbsp;&nbsp;&nbsp;&nbsp;http://www.cnn.com/<br />&nbsp;&nbsp;&nbsp;&nbsp;http://news.ycombinator.com/<br />)</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$f</span> <span class="operator">=</span> <span class="word">Fetcher</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">url</span> <span class="operator">=&gt;</span> <span class="magic">$_</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">say</span> <span class="double">&quot;SANTA IS HAPPENING&quot;</span> <span class="word">if</span> <span class="symbol">$f</span><span class="operator">-&gt;</span><span class="word">fetch</span> <span class="operator">=~</span> <span class="match">/santa/i</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>It takes the about same time:</p>

<pre><code>    $ time perl -I. santa.pl 

    real    0m1.254s
    user    0m0.090s
    sys     0m0.026s

    $ time perl -I. santa.pl 

    real    0m2.921s
    user    0m0.087s
    sys     0m0.028s

    $ time perl -I. santa.pl 

    real    0m1.203s
    user    0m0.085s
    sys     0m0.024s</code></pre>

<p>The problem is that Memoize sees each instance of <code>$f</code> as being different between each run - it can&#39;t tell that an <code>$f</code> constructed with the same url will produce the same result. We can fix this with a <i>normalizer</i></p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">memoize</span> <span class="single">'fetch'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;<span class="word">SCALAR_CACHE</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="word">HASH</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">%cache</span><span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;<span class="word">NORMALIZER</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($f,@)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$f</span><span class="operator">-&gt;</span><span class="word">url</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;<span class="structure">};</span></code><br />&nbsp;</td></table>

<p>It&#39;s the job of the normalizer to take the arguments and return a suitable cache key. Here we&#39;re just using the URL that <code>$f</code> has, as that&#39;s the only thing that matters. Caching now works:</p>

<pre><code>    $ time perl -I. santa.pl 

    real    0m3.503s
    user    0m0.125s
    sys     0m0.022s
    
    $ time perl -I. santa.pl 

    real    0m0.068s
    user    0m0.063s
    sys     0m0.005s</code></pre>

<h3 id="In-Conclusion">In Conclusion</h3>

<p>So it turns out what we&#39;d been thinking purely as a way of speeding up our code in limited circumstances is even more valuable as a tool to create temporary code in development to help us stop going insane. There&#39;s life in the old module yet!</p>

<h3 id="P.S.-You-can-Leave-it-in-the-production-code">P.S. You can Leave it in the production code</h3>

<p>What if your one off script becomes something you run once a day or so? We all know that happens more often than we&#39;d like.</p>

<p>The above code isn&#39;t suitable for that - it&#39;ll forever remember the news on the day the code was first run! (Or at least until the computer is restarted and <code>/tmp</code> is cleared out). What we need is for our cache to expire after, say, an hour.</p>

<p>Memoize, with the help of another core module, can do that too with layers of tied hashes:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">tie</span> <span class="word">my</span> <span class="symbol">%cache</span> <span class="operator">=&gt;</span> <span class="single">'DB_File'</span><span class="operator">,</span> <span class="single">'/tmp/memoize'</span><span class="operator">,</span> <span class="word">O_CREAT</span><span class="operator">|</span><span class="word">O_RDWR</span><span class="operator">,</span> <span class="octal">0666</span><span class="structure">];</span><br /><span class="word">tie</span> <span class="word">my</span> <span class="symbol">%forgetful</span> <span class="operator">=&gt;</span> <span class="single">'Memoize::Expire'</span><span class="operator">,</span> <span class="word">LIFETIME</span> <span class="operator">=&gt;</span> <span class="number">3600</span><span class="operator">,</span> <span class="word">HASH</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">%cache</span><span class="structure">;</span> <br /><span class="word">memoize</span> <span class="single">'fetch'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">SCALAR_CACHE</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="word">HASH</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">%forgetful</span><span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">NORMALIZER</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($f,@)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$f</span><span class="operator">-&gt;</span><span class="word">url</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span></code><br />&nbsp;</td></table>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Core Strength" href="2019-12-18.html">Previous</a></li>

    <li class="next"><a title="Controlling your Terminal with Perl" href="2019-12-20.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





