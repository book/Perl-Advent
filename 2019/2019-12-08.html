<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Christmas Movie Time!

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Christmas Movie Time!</h1>
<div class='subtitle'>PerlIO::zip - 2019-12-08</div>

<div class='pod'><p>Have you ever wondered what the best Christmas Movie of all time is?</p>

<p>Spoiler Alert: It&#39;s &quot;It&#39;s a Wonderful Life&quot;.</p>

<center><iframe src="https://player.vimeo.com/video/280022699" width="640" height="480" frameborder="0" allow="fullscreen" allowfullscreen></iframe></center>

<p>Of course, that&#39;s not just my opinion: I can prove it...with Perl.</p>

<h3 id="Christmas-Movies">Christmas Movies</h3>

<p>The first thing we need to prove this comprehensively is a collection of Christmas movies.</p>

<p>Did you know that Wikipedia has a <a href="https://en.wikipedia.org/wiki/List_of_Christmas_films">list of Christmas movies</a> on it? Neither did I, but I shouldn&#39;t be surprised; It has pretty much everything and the <a href="https://en.wikipedia.org/wiki/Kitchen_sink">kitchen sink</a> on it. Let&#39;s scrape that list and put it in a database.</p>

<p>First, we create need a table:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> wikipedia_films (<br />&nbsp;&nbsp;&nbsp;&nbsp;name TEXT,<br />&nbsp;&nbsp;&nbsp;&nbsp;year <span class="synType">INTEGER</span><br />);</code><br />&nbsp;</td></table>

<p>We can use the on-disk daemonless SQLite SQL database to do this. Most systems ship with the <code>sqlite3</code> command line tool that&#39;ll write the database from the SQL for us:</p>

<pre><code>    $ sqlite3 /tmp/db &lt; wikipedia_films.sql</code></pre>

<p>Now we need a program that can scrape the web page and populate the database. Easy-peasy with Mojo::UserAgent, which we&#39;ve covered extensively in past advent calendars:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">DBI</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::UserAgent</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$dbh</span> <span class="operator">=</span> <span class="word">DBI</span><span class="operator">-&gt;</span><span class="word">connect</span><span class="structure">(</span><span class="double">&quot;dbi:SQLite:dbname=/tmp/db&quot;</span><span class="structure">);</span><br /><br /><span class="keyword">my</span> <span class="symbol">$ua</span> <span class="operator">=</span> <span class="word">Mojo::UserAgent</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><span class="keyword">my</span> <span class="symbol">$res</span> <span class="operator">=</span> <span class="symbol">$ua</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'https://en.wikipedia.org/wiki/List_of_Christmas_films'</span><br /><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">result</span><span class="structure">;</span><br /><span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$res</span><span class="operator">-&gt;</span><span class="word">is_error</span><span class="structure">)</span> <span class="structure">{</span> <span class="word">die</span> <span class="symbol">$res</span><span class="operator">-&gt;</span><span class="word">message</span> <span class="structure">}</span><br /><br /><span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">begin_work</span><span class="structure">;</span><br /><span class="symbol">$res</span><span class="operator">-&gt;</span><span class="word">dom</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><span class="single">'.wikitable tbody tr'</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">each</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$a</span> <span class="operator">=</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="double">&quot;td:first-child * a&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span> <span class="word">unless</span> <span class="symbol">$a</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$a</span><span class="operator">-&gt;</span><span class="word">text</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$year</span> <span class="operator">=</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">at</span><span class="structure">(</span><span class="double">&quot;td:nth-child(2)&quot;</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">text</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">say</span> <span class="word">STDERR</span> <span class="double">&quot;Inserting $name ($year)&quot;</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">do</span><span class="structure">(</span> <span class="heredoc">&lt;&lt;'SQL'</span><span class="operator">,</span> <span class="structure">{}</span><span class="operator">,</span> <span class="symbol">$name</span><span class="operator">,</span> <span class="symbol">$year</span> <span class="structure">);</span><br /><span class="heredoc_content">        INSERT INTO wikipedia_films<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(name, year) VALUES (?,?)<br /></span><span class="heredoc_terminator">SQL<br /></span><span class="structure">});</span><br /><span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">commit</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Now we&#39;ve got a big old list in our database...but what&#39;s the best of these movies?</p>

<h2 id="Downloading-The-IMDb">Downloading The IMDb</h2>

<p>If we&#39;re being <i>scientific</i> about this we shouldn&#39;t just use <i>our</i> opinion. We should use the wisdom of crowds: The Internet Movie Database rating for the film.</p>

<p>So that&#39;s straight forward: First we just download the entire of the IMDb...wait, you didn&#39;t know we could do that? Sure! The IMDb publishes a bunch of tab separated compressed files of their core data every day.</p>

<p>If we use lwp-mirror to download the files we can mirror the large files to disk.</p>

<pre><code>   $ lwp-mirror https://datasets.imdbws.com/title.basics.tsv.gz title.basics.tsv.gz
   $ lwp-mirror https://datasets.imdbws.com/title.ratings.tsv.gz title.ratings.tsv.gz</code></pre>

<p>Because we&#39;re using lwp-mirror we can safely re-run the downloads as often as we want - a new version will only be downloaded when the contents changes.</p>

<h2 id="Importing-into-Our-Database">Importing into Our Database</h2>

<p>Okay, we next need to put all of that data into our database. Let&#39;s create a new table:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> imdb_films (<br />&nbsp;&nbsp;&nbsp;&nbsp;title TEXT,<br />&nbsp;&nbsp;&nbsp;&nbsp;name TEXT,<br />&nbsp;&nbsp;&nbsp;&nbsp;year <span class="synType">INTEGER</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;rating <span class="synType">FLOAT</span><br />);<br /><br /><span class="synStatement">CREATE</span> <span class="synSpecial">INDEX</span> imdb_films_title_idx<br /><span class="synSpecial">ON</span> imdb_films(title);</code><br />&nbsp;</td></table>

<p>In the database:</p>

<pre><code>    $ sqlite3 /tmp/db &lt; imdb_films.sql</code></pre>

<p>And populate it with films:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">DBI</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">List::AllUtils</span> <span class="words">qw( zip )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::UserAgent</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">PerlIO::gzip</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Term::ProgressBar</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$dbh</span> <span class="operator">=</span> <span class="word">DBI</span><span class="operator">-&gt;</span><span class="word">connect</span><span class="structure">(</span><span class="double">&quot;dbi:SQLite:dbname=/tmp/db&quot;</span><span class="structure">);</span><br /><br /><span class="comment"># how big is this file?<br /></span><span class="keyword">my</span> <span class="symbol">$total</span> <span class="operator">=</span> <span class="backtick">`gunzip -c title.basics.tsv.gz | wc -l`</span><span class="structure">;</span><br /><br /><span class="comment"># the file is gzipped, so use the gzip layer<br /># to transparently decompress it as we read it<br /></span><span class="word">open</span> <span class="word">my</span> <span class="symbol">$fh</span><span class="operator">,</span> <span class="single">'&lt;:gzip'</span><span class="operator">,</span> <span class="single">'title.basics.tsv.gz'</span><br /><span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;Can't open file: $!&quot;</span><span class="structure">;</span><br /><br /><span class="comment"># read the first line in that contains the headings<br /></span><span class="magic">$_</span> <span class="operator">=</span> <span class="readline">&lt;$fh&gt;</span><span class="structure">;</span><br /><span class="word">chomp</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">@headings</span> <span class="operator">=</span> <span class="word">split</span> <span class="match">/\t/</span><span class="structure">;</span><br /><br /><span class="comment"># prepare the insert statement<br /></span><span class="keyword">my</span> <span class="symbol">$sth</span> <span class="operator">=</span> <span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">prepare</span><span class="structure">(</span><span class="heredoc">&lt;&lt;'SQL'</span><span class="structure">);</span><br /><span class="heredoc_content">    INSERT INTO imdb_films<br />&nbsp;&nbsp;&nbsp;&nbsp;( title, name, year )<br />&nbsp;&nbsp;&nbsp;&nbsp;VALUES<br />&nbsp;&nbsp;&nbsp;&nbsp;( ?, ?, ?)<br /></span><span class="heredoc_terminator">SQL<br /></span><br /><span class="comment"># process each row of the file<br /></span><span class="keyword">my</span> <span class="symbol">$progress</span> <span class="operator">=</span> <span class="word">Term::ProgressBar</span><span class="operator">-&gt;</span><span class="word">new</span> <span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">count</span> <span class="operator">=&gt;</span> <span class="symbol">$total</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">ETA</span>   <span class="operator">=&gt;</span> <span class="single">'linear'</span><span class="operator">,</span><br /><span class="structure">});</span><br /><span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">begin_work</span><span class="structure">;</span><br /><span class="keyword">while</span> <span class="structure">(</span><span class="readline">&lt;$fh&gt;</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">chomp</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@row_data</span> <span class="operator">=</span> <span class="word">split</span> <span class="match">/\t/</span><span class="structure">;</span><br /><br /><span class="comment">    # zip returns an element from each of the arrays <br />&nbsp;&nbsp;&nbsp;&nbsp;# in turn i.e. key, value, key, value, key, value...<br /></span>    <span class="keyword">my</span> <span class="symbol">%data</span> <span class="operator">=</span> <span class="word">zip</span> <span class="symbol">@headings</span><span class="operator">,</span> <span class="symbol">@row_data</span><span class="structure">;</span><br /><br /><span class="comment">    # ignore anything that isn't a movie or, ahem, isn't<br />&nbsp;&nbsp;&nbsp;&nbsp;# in the true christmas spirit<br /></span>    <span class="word">next</span> <span class="word">if</span> <span class="symbol">$data</span><span class="structure">{</span><span class="word">titleType</span><span class="structure">}</span> <span class="operator">ne</span> <span class="single">'movie'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span> <span class="word">if</span> <span class="symbol">$data</span><span class="structure">{</span><span class="word">isAdult</span><span class="structure">};</span><br /><br /><span class="comment">    # insert just some of the fields from the data<br />&nbsp;&nbsp;&nbsp;&nbsp;# note ratings aren't in here yet - next script!<br /></span>    <span class="symbol">$sth</span><span class="operator">-&gt;</span><span class="word">execute</span><span class="structure">(</span><span class="symbol">@data</span><span class="structure">{</span><span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tconst<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;originalTitle<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;startYear<br />&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="structure">});</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$progress</span><span class="operator">-&gt;</span><span class="word">update</span><span class="structure">(</span><span class="magic">$.</span><span class="structure">);</span><br /><span class="structure">}</span><br /><span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">commit</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>And do almost same thing with the ratings for the films:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">DBI</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">List::AllUtils</span> <span class="words">qw( zip )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Mojo::UserAgent</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">PerlIO::gzip</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Term::ProgressBar</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$dbh</span> <span class="operator">=</span> <span class="word">DBI</span><span class="operator">-&gt;</span><span class="word">connect</span><span class="structure">(</span><span class="double">&quot;dbi:SQLite:dbname=/tmp/db&quot;</span><span class="structure">);</span><br /><br /><span class="comment"># how big is this file?<br /></span><span class="keyword">my</span> <span class="symbol">$total</span> <span class="operator">=</span> <span class="backtick">`gunzip -c title.ratings.tsv.gz | wc -l`</span><span class="structure">;</span><br /><br /><span class="comment"># the file is gzipped, so use the gzip layer<br /># to transparently decompress it as we read it<br /></span><span class="word">open</span> <span class="word">my</span> <span class="symbol">$fh</span><span class="operator">,</span> <span class="single">'&lt;:gzip'</span><span class="operator">,</span> <span class="single">'title.ratings.tsv.gz'</span><br /><span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;Can't open file: $!&quot;</span><span class="structure">;</span><br /><br /><span class="comment"># read the first line in that contains the headings<br /></span><span class="magic">$_</span> <span class="operator">=</span> <span class="readline">&lt;$fh&gt;</span><span class="structure">;</span><br /><span class="word">chomp</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">@headings</span> <span class="operator">=</span> <span class="word">split</span> <span class="match">/\t/</span><span class="structure">;</span><br /><br /><span class="comment"># prepare the insert statement<br /></span><span class="keyword">my</span> <span class="symbol">$sth</span> <span class="operator">=</span> <span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">prepare</span><span class="structure">(</span><span class="heredoc">&lt;&lt;'SQL'</span><span class="structure">);</span><br /><span class="heredoc_content">    UPDATE imdb_films<br />&nbsp;&nbsp;&nbsp;&nbsp;SET rating = ?<br />&nbsp;&nbsp;&nbsp;&nbsp;WHERE title = ?<br /></span><span class="heredoc_terminator">SQL<br /></span><br /><span class="comment"># process each row of the file<br /></span><span class="keyword">my</span> <span class="symbol">$progress</span> <span class="operator">=</span> <span class="word">Term::ProgressBar</span><span class="operator">-&gt;</span><span class="word">new</span> <span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">count</span> <span class="operator">=&gt;</span> <span class="symbol">$total</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">ETA</span>   <span class="operator">=&gt;</span> <span class="single">'linear'</span><span class="operator">,</span><br /><span class="structure">});</span><br /><span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">begin_work</span><span class="structure">;</span><br /><span class="keyword">while</span> <span class="structure">(</span><span class="readline">&lt;$fh&gt;</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">chomp</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@row_data</span> <span class="operator">=</span> <span class="word">split</span> <span class="match">/\t/</span><span class="structure">;</span><br /><br /><span class="comment">    # zip returns an element from each of the arrays <br />&nbsp;&nbsp;&nbsp;&nbsp;# in turn i.e. key, value, key, value, key, value...<br /></span>    <span class="keyword">my</span> <span class="symbol">%data</span> <span class="operator">=</span> <span class="word">zip</span> <span class="symbol">@headings</span><span class="operator">,</span> <span class="symbol">@row_data</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$sth</span><span class="operator">-&gt;</span><span class="word">execute</span><span class="structure">(</span><span class="symbol">@data</span><span class="structure">{</span><span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;averageRating<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tconst<br />&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="structure">});</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$progress</span><span class="operator">-&gt;</span><span class="word">update</span><span class="structure">(</span><span class="magic">$.</span><span class="structure">);</span><br /><span class="structure">}</span><br /><span class="symbol">$dbh</span><span class="operator">-&gt;</span><span class="word">commit</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<h3 id="The-Moment-of-Truth">The Moment of Truth</h3>

<p>Finally, we can categorically prove what&#39;s the best Christmas Film</p>

<pre><code>    $ sqlite3 /tmp/db
    sqlite&gt; SELECT name
       ...&gt; FROM wikipedia_films
       ...&gt; JOIN imdb_films
       ...&gt; USING (name, year)
       ...&gt; ORDER BY rating DESC
       ...&gt; LIMIT 1;
    It&#39;s a Wonderful Life</code></pre>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Show Me Mo&#39;" href="2019-12-07.html">Previous</a></li>

    <li class="next"><a title="Command Line Browser Apps" href="2019-12-09.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





