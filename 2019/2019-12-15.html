<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Suddenly Serverless

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Suddenly Serverless</h1>
<div class='subtitle'>AWS::Lambda::Quick - 2019-12-15</div>

<div class='pod'><p>It was five minutes to midnight on Christmas Eve. And Sugarplum Snoozysnaps was going to have a heart attack.</p>

<p>All these months of planning. And it&#39;d all come crashing down thirty seconds ago. Literally. They never should have made the server racks out of candy canes. Too tempting for Yukon Cornelius&#39; sweet tooth.</p>

<p>Now in five minutes the elves on the shelves needed to know the exact moment to fly home so they wouldn&#39;t impact Santa coming the other way and the website that they were meant to check was down.</p>

<p>&quot;In the next five minutes I&#39;ve got to write a whole new web service. I&#39;ve got to deploy it live. And it&#39;s got to scale up to millions of hits.&quot;</p>

<p>Don&#39;t Panic Sugarplum! You&#39;re the most experienced Elf that Santa has. You can find a way to do the impossible again!</p>

<h3 id="AWS-Lambda">AWS Lambda</h3>

<p>AWS Lambda is one of the new breed of <i>serverless</i> infrastructure offerings. Serverless doesn&#39;t mean that there aren&#39;t web servers running the code behind the scenes, but rather the programmer doesn&#39;t have to worry about them - their concerns only go as far as writing individual logic that creates the pages. Someone else handles the rest.</p>

<p>This means that Sugarplum doesn&#39;t have to worry about setting up new hardware in the next three hundred seconds she has to spare. It even means that she doesn&#39;t have to worry about configuring a pack of virtual machines or even a bunch of Kubernetes pods. All she has to worry about is writing the function - Amazon will take care of the compute for running them and scaling what&#39;s needed so the elves on the shelves don&#39;t overload anything. The north pole will get the first million hits for free, then they&#39;ll be billed a small amount for each hit.</p>

<p>So, what does a Lambda function look like in Perl? Why it&#39;s nothing more than a script that contains a <code>handler</code> function and ends with a true value.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">handler</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$data</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">queryStringParameters</span><span class="structure">}{</span><span class="word">who</span><span class="structure">}</span> <span class="operator">//</span> <span class="double">&quot;Santa&quot;</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">statusCode</span> <span class="operator">=&gt;</span> <span class="number">200</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">headers</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Content-Type'</span> <span class="operator">=&gt;</span> <span class="single">'text/plain'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">body</span> <span class="operator">=&gt;</span> <span class="double">&quot;Hello, $name&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Deploying with Lambda is quick - it takes just a few seconds to push up some code and enable it live. Can Sugarplum get it done in time?</p>

<h3 id="Do-It-Quickly">Do It <i>Quickly</i></h3>

<p>Okay, first things first. Sugarplum has to install the AWS tooling on her machine. This&#39;ll take her about thirty seconds. She only has to copy and paste three lines from the AWS webpages to her command line:</p>

<pre><code>    shell$ curl &quot;https://s3.amazonaws.com/aws-cli/awscli-bundle.zip&quot; -o &quot;awscli-bundle.zip&quot;
    shell$ unzip awscli-bundle.zip
    shell$ sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws</code></pre>

<p>Luckily for Sugarplum the north pole has already set up an Amazon account for use with AWS, and has funding source associated with it (less lucky for the Wise Old Elf whose credit card is about to take a pounding in the next few minutes.)</p>

<p>She can spend about a minute <a href="https://aws.amazon.com/blogs/security/how-to-find-update-access-keys-password-mfa-aws-management-console">finding the AWS credentials for her account</a> which she can then use in conjunction with the <code>aws configure</code> command:</p>

<pre><code>    shell$ aws configure
    AWS Access Key ID [********************]:
    AWS Secret Access Key [********************]:
    Default region name [us-east-1]:
    Default output format [None]:</code></pre>

<p>She now has access to the awesome power of AWS. She&#39;s got three minutes and thirty seconds to get everything live!</p>

<h3 id="The-Actual-Coding">The Actual Coding</h3>

<p>Three minutes later she&#39;s got the most basic of web pages ready to go:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="pragma">lib</span> <span class="words">qw( lib )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">NorthPole::ElfOnTheShelfDispatch</span> <span class="words">qw( time_to_go )</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$template</span> <span class="operator">=</span> <span class="heredoc">&lt;&lt;'HTML'</span><span class="structure">;</span><br /><span class="heredoc_content">&lt;html&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;&lt;title&gt;Elf on the Shelf Dispatch Instructions&lt;/title&gt;&lt;/head&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;INSTRUCTION&lt;/h1&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;It is absolutely imperative at this time you INSTRUCTION&lt;/p&gt;<br />&lt;/html&gt;<br /></span><span class="heredoc_terminator">HTML<br /></span><br /><span class="keyword">sub</span> <span class="word">handler</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$data</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">queryStringParameters</span><span class="structure">}{</span><span class="word">name</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$instruction</span> <span class="operator">=</span> <span class="word">time_to_go</span><span class="structure">(</span><span class="symbol">$name</span><span class="structure">)</span> <span class="operator">?</span> <span class="single">'LEAVE NOW'</span> <span class="operator">:</span> <span class="single">'STAY PUT'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$html</span> <span class="operator">=</span> <span class="symbol">$template</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$template</span> <span class="operator">=~</span> <span class="substitute">s/INSTRUCTION/$instruction/g</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">statusCode</span> <span class="operator">=&gt;</span> <span class="number">200</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">headers</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Content-Type'</span> <span class="operator">=&gt;</span> <span class="single">'text/html'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">body</span> <span class="operator">=&gt;</span> <span class="symbol">$html</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Thank goodness she was able to re-use the NorthPole::ElfOnTheShelfDispatch module that used to run on those destroyed servers. Using a combination of the time of day and the elf&#39;s family name (the clan the Elf was in determined where they&#39;d been deployed around the world) it was able to work out what the elf should do at the moment they refreshed the page.</p>

<p>Now all Sugarplum has to do was work out how to deploy this code to AWS. Should be straight forward, right...it&#39;s just a few API calls.</p>

<h3 id="Complexity">Complexity</h3>

<p>The great thing about AWS is that it&#39;s a super powerful set of infrastructure that&#39;s capable of doing almost anything you can ask of it. The problem is, you have to work out how to ask for exactly what you want.</p>

<p>To configure the AWS Lambda function to respond to a HTTP URL you need to take the following steps:</p>

<dl>

<dt>Create a zip file containing all your code and supporting code.</dt>
<dd>

</dd>
<dt>Create (or update) an AWS Lambda function with this zip file, and configure Lambda to use the latest Perl layers to automatically bring in the necessary AWS::Lamba support code.</dt>
<dd>

</dd>
<dt>Define a Role with the permissions to run your code.</dt>
<dd>

</dd>
<dt>Create a REST API with AWS Gateway API.</dt>
<dd>

</dd>
<dt>Configure a resource for that REST API for this script.</dt>
<dd>

</dd>
<dt>Set up a method and put method response for that resource.</dt>
<dd>

</dd>
<dt>Manage an integration and integration response for that resource.</dt>
<dd>

</dd>
</dl>

<p>Nothing too complicated...I&#39;m <i>sure</i> Sugarplum can get all that done in the next thirty seconds.</p>

<h3 id="CPAN-to-the-Rescue">CPAN to the Rescue!</h3>

<p>When you need to setup a Lambda function in a hurry there&#39;s <a href="https://metacpan.org/module/AWS::Lambda::Quick">AWS::Lambda::Quick</a>.</p>

<p>All you need to do is put a single use statement at the top of your code:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">AWS::Lambda::Quick</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'elf-on-the-shelf-go'</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Or, rather, since we need to also upload the <code>lib</code> directory:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">AWS::Lambda::Quick</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'elf-on-the-shelf-go'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">extra_files</span> <span class="operator">=&gt;</span> <span class="structure">[</span><span class="single">'lib'</span><span class="structure">]</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>And then run the script.</p>

<pre><code>    shell$ perl elf-on-the-shelf-go.pl
    https://52p3rf890b.execute-api.us-east-1.amazonaws.com/quick/elf-on-the-shelf-go</code></pre>

<p>Look, it&#39;s printed out a URL where it&#39;s already live!</p>

<p>AWS::Lambda::Quick has handled all the interactions with AWS for us, uploading a copy of the script (slightly modified so it no longer depends on AWS::Lambda::Quick&gt; and configuring AWS to serve it for us on the URL it printed out. That didn&#39;t even take 30 seconds!</p>

<p>If we want, we can even see what it&#39;s up to:</p>

<pre><code>    shell$ export AWS_LAMBDA_QUICK_DEBUG=1
    shell$ perl elf-on-the-shelf-go.pl
    updating function code
    function code updated
    updating function configuration
    searching for existing role
    found existing role
    function configuration updated
    searching for existing rest api
    found existing existing rest api
    searching of existing resource
    found exiting resource
    checking for existing method
    found existing method
    checking for existing method response
    found existing method response
    checking for existing integration
    found existing integration
    checking for existing integration response
    found existing integration response
    https://52p3rf890b.execute-api.us-east-1.amazonaws.com/quick/elf-on-the-shelf-go</code></pre>

<p>All that&#39;s left for us to do is test it:</p>

<p><a href="https://52p3rf890b.execute-api.us-east-1.amazonaws.com/quick/elf-on-the-shelf-go?who=Candy+Sweettooth">https://52p3rf890b.execute-api.us-east-1.amazonaws.com/quick/elf-on-the-shelf-go?who=Candy+Sweettooth</a></p>

<p><a href="https://52p3rf890b.execute-api.us-east-1.amazonaws.com/quick/elf-on-the-shelf-go?who=Zippy+Flyfast">https://52p3rf890b.execute-api.us-east-1.amazonaws.com/quick/elf-on-the-shelf-go?who=Zippy+Flyfast</a></p>

<p>Well done Sugarplum, Christmas is once again truly saved!</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Animated GIFs" href="2019-12-14.html">Previous</a></li>

    <li class="next"><a title="Paws to Plan What Todo" href="2019-12-16.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





