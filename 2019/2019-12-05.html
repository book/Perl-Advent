<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.112" />
    <link rel="alternate" title="Perl Advent Calendar 2019 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2019.css" type="text/css" />
    <title>
Perl Advent Calendar 2019 - 
Christmas Lights

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2019</a></h1>
        </div>

        <p id="tagline">2019 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Christmas Lights</h1>
<div class='subtitle'>Phillips Hue Home Bridge - 2019-12-05</div>

<div class='pod'><p><center><img src="lights.gif" width-"300" height="300" alt="Hue Lights In Christmas Mode" style="border: 5px solid black"></center>

</p>



<h3 id="Smart-but-Dumb">Smart, but Dumb</h3>

<p>The lighting system in my house is <i>smart</i>. I can ask Alexa to turn lights on and off, or I can press buttons mounted on my wall to select preselected scenes of lights. Lights come on automatically when it gets dark, and turn off automatically at last thing at night (since, you know, my kids are always leaving their closet lights on.)</p>

<p>But the lights in my house are also <i>dumb</i>. They don&#39;t turn on when I wake up in the morning, they don&#39;t change their appearance due to whatever&#39;s going on in the world. They don&#39;t even know to get my attention when I get that all important email!</p>

<p>Right now they look the same all year round. Heck, do they even know it&#39;s Christmas time at all?</p>

<p>I can fix all of this though...with Perl.</p>

<h3 id="Phillips-Hue-Home-Bridge">Phillips Hue Home Bridge</h3>

<p>My lights use the peer-to-peer zigbee wireless protocol to relay control messages to each other. Command and control is handled by a Phillips Hue Home Bridge, a small &#39;puck&#39; shaped device with an ethernet socket in the back that can monitor the zigbee sensors and send out zigbee commands.</p>

<p>The normal way to control the Hue bridge is with the GUI of the Hue app from your smartphone. But anything the smart phone can do you can also do through the Hub&#39;s HTTP REST API...and with that, from Perl.</p>

<p>The first step is to find out what the local internal IP address of the Hue Bridge is. If it can talk to the internet the Hue Bridge registers the current internal API it has with the central Phillips servers. You can query them with a simple HTTP JSON API call:</p>

<pre><code>   $ curl https://www.meethue.com/api/nupnp
   [{&quot;id&quot;:&quot;001788fffead6e94&quot;,&quot;internalipaddress&quot;:&quot;192.168.1.2&quot;}]</code></pre>

<p>Sweet. The only other thing we need to do is get any API key we can use to talk to the bridge. This can be achieved by POSTing some JSON to the local Hue Bridge.</p>

<pre><code>    $ curl -X POST -d &#39;{&quot;devicetype&quot;:&quot;perl-interface&quot;}&#39; http://192.168.1.2/api
    [{&quot;error&quot;:{&quot;type&quot;:101,&quot;address&quot;:&quot;&quot;,&quot;description&quot;:&quot;link button not pressed&quot;}}]</code></pre>

<p>Wait, that didn&#39;t give us an API key...oh, right, it now wants us to press the button on the top of the hub to prove we&#39;re authorized to get a new API key. Let&#39;s press it, then try that again:</p>

<pre><code>    curl -X POST -d &#39;{&quot;devicetype&quot;:&quot;perl-interface&quot;}&#39; http://192.168.1.2/api
    [{&quot;success&quot;:{&quot;username&quot;:&quot;xyznl1BwQryLMOhJ3uNPUxnR7eQIwwqrkd5Kt0dd&quot;}}]</code></pre>

<p>Great, that <i>username</i> is our key. With it we can start making API calls:</p>

<pre><code>    curl http://192.168.1.2/api/xyznl1BwQryLMOhJ3uNPUxnR7eQIwwqrkd5Kt0dd/config | json_pp
    {
        &quot;netmask&quot; : &quot;255.255.255.0&quot;,
        &quot;portalstate&quot; : {
            &quot;signedon&quot; : true,
            &quot;incoming&quot; : false,
            &quot;outgoing&quot; : true,
            &quot;communication&quot; : &quot;disconnected&quot;
        },
        &quot;apiversion&quot; : &quot;1.35.0&quot;,
        &quot;backup&quot; : {
            &quot;status&quot; : &quot;idle&quot;,
            &quot;errorcode&quot; : 0
        },
        &quot;portalservices&quot; : true,
        ...</code></pre>

<h3 id="Building-a-Bridge-Class">Building a Bridge Class</h3>

<p>Messing around with the <code>curl</code> command is going to get tiresome fast, so it&#39;s time to break out our Perl code.</p>

<p>First let&#39;s start by writing a Bridge class that can handle the basics of talking HTTP to our Hue Bridge.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Bridge</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moo</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">HTTP::Tiny</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">JSON::PP</span> <span class="words">qw( encode_json decode_json )</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="word">http_tiny</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="keyword">return</span> <span class="word">HTTP::Tiny</span><span class="operator">-&gt;</span><span class="word">new</span> <span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="word">has</span> <span class="word">key</span> <span class="operator">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span> <span class="word">default</span> <span class="operator">=&gt;</span> <span class="symbol">$ENV</span><span class="structure">{</span><span class="word">HUE_KEY</span><span class="structure">}</span> <span class="structure">);</span><br /><br /><span class="word">has</span> <span class="word">ip_address</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($self, @)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$response</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">http_tiny</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="single">'https://www.meethue.com/api/nupnp'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">die</span> <span class="single">'Failed!'</span> <span class="word">unless</span> <span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">success</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$result</span> <span class="operator">=</span> <span class="word">decode_json</span><span class="structure">(</span><span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">content</span><span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$result</span><span class="operator">-&gt;</span><span class="structure">[</span><span class="number">0</span><span class="structure">]{</span><span class="word">internalipaddress</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="comment"># get the data from the URL fragment, and return the parsed JSON (if any)<br /></span><span class="keyword">sub</span> <span class="word">get</span> <span class="prototype">($self, $fragment)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$url</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_url</span><span class="structure">(</span><span class="symbol">$fragment</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$tiny</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">http_tiny</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$response</span> <span class="operator">=</span> <span class="symbol">$tiny</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="symbol">$url</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">die</span> <span class="single">'Failed!'</span> <span class="word">unless</span> <span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">success</span><span class="structure">};</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">decode_json</span><span class="structure">(</span><span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">content</span><span class="structure">})</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">if</span> <span class="word">length</span> <span class="symbol">$response</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">content</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="core">undef</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="comment"># turn the URL fragment into a full API URL<br /></span><span class="keyword">sub</span> <span class="word">_url</span> <span class="prototype">($self, $fragment)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="single">'http://'</span> <span class="operator">.</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">ip_address</span> <span class="operator">.</span> <span class="single">'/api/'</span> <span class="operator">.</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">key</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">.</span> <span class="symbol">$fragment</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Let&#39;s use a simple script to see it in action</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Bridge</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Data::Dumper</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$bridge</span> <span class="operator">=</span> <span class="word">Bridge</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><span class="word">print</span> <span class="word">Dumper</span> <span class="symbol">$bridge</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span><span class="single">'/lights/1'</span><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>This prints out <i>so much information</i>:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="symbol">$VAR1</span> <span class="operator">=</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'name'</span> <span class="operator">=&gt;</span> <span class="single">'Left office'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'type'</span> <span class="operator">=&gt;</span> <span class="single">'Dimmable light'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'modelid'</span> <span class="operator">=&gt;</span> <span class="single">'LWB014'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'manufacturername'</span> <span class="operator">=&gt;</span> <span class="single">'Philips'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'productid'</span> <span class="operator">=&gt;</span> <span class="single">'Philips-LWB014-1-A19DLv4'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'state'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'reachable'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'mode'</span> <span class="operator">=&gt;</span> <span class="single">'homeautomation'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'bri'</span> <span class="operator">=&gt;</span> <span class="number">254</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'alert'</span> <span class="operator">=&gt;</span> <span class="single">'lselect'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'on'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'uniqueid'</span> <span class="operator">=&gt;</span> <span class="single">'00:17:88:01:03:c0:d5:d1-0b'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'swversion'</span> <span class="operator">=&gt;</span> <span class="single">'1.46.13_r26312'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'swconfigid'</span> <span class="operator">=&gt;</span> <span class="single">'69806BE9'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'capabilities'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'control'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'maxlumen'</span> <span class="operator">=&gt;</span> <span class="number">840</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'mindimlevel'</span> <span class="operator">=&gt;</span> <span class="number">2000</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'certified'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'streaming'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'renderer'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'proxy'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'swupdate'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'state'</span> <span class="operator">=&gt;</span> <span class="single">'noupdates'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'lastinstall'</span> <span class="operator">=&gt;</span> <span class="single">'2019-05-06T18:53:05'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'config'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'function'</span> <span class="operator">=&gt;</span> <span class="single">'functional'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'archetype'</span> <span class="operator">=&gt;</span> <span class="single">'classicbulb'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'direction'</span> <span class="operator">=&gt;</span> <span class="single">'omnidirectional'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'startup'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'configured'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'mode'</span> <span class="operator">=&gt;</span> <span class="single">'safety'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'productname'</span> <span class="operator">=&gt;</span> <span class="single">'Hue white lamp'</span><br /><span class="structure">};</span></code><br />&nbsp;</td></table>

<h3 id="Building-Out-the-Abstraction">Building Out the Abstraction</h3>

<p>Those are quite big data structures! What we need to do is work on an abstraction layer or two that will make working with them easier.</p>

<p>First let&#39;s implement a generic <code>Item</code> role for all items. This&#39;ll handle the nitty gritty of calling the API to fetch data whenever we want something:</p>

<pre><code>    package Role::Item;

    use Moo::Role;
    use experimental &#39;signatures&#39;;

    use Bridge;

    # we need an &#39;endpoint&#39; method that&#39;ll give us the
    # part of the URL we&#39;re constructing
    requires &#39;endpoint&#39;;

    has bridge =&gt; (
        is =&gt; &#39;lazy&#39;,
        default =&gt; sub { Bridge-&gt;new() },
    );

    has id =&gt; ( is =&gt; &#39;ro&#39; );

    # this is where the data from the server is lazy-loaded via
    # the REST API
    has _data =&gt; (
        is =&gt; &#39;ro&#39;,
        clearer =&gt; &#39;flush_cache&#39;,
        lazy =&gt; 1,
        default =&gt; sub ($self) {
            return $self-&gt;bridge-&gt;get($self-&gt;endpoint.&#39;/&#39;.$self-&gt;id);
        },
    );

    # all things in the Hue API (lights, sensors, rules, etc) have names
    sub name ($self) { $self-&gt;_data-&gt;{name} }

    1;</code></pre>

<p>And we can implement that in a basic Light class:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Light</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moo</span><span class="structure">;</span><br /><span class="word">with</span> <span class="single">'Role::Item'</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">endpoint</span> <span class="structure">{</span> <span class="single">'/lights'</span> <span class="structure">}</span><br /><br /><span class="comment"># a few basic facts about the light from the data structure<br /></span><span class="keyword">sub</span> <span class="word">on</span>         <span class="prototype">($self)</span> <span class="structure">{</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">state</span><span class="structure">}{</span><span class="word">on</span><span class="structure">}</span> <span class="structure">}</span><br /><span class="keyword">sub</span> <span class="word">brightness</span> <span class="prototype">($self)</span> <span class="structure">{</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">state</span><span class="structure">}{</span><span class="word">bri</span><span class="structure">}</span> <span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Which means we can easily write a script to find the status of a given light:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Light</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$light</span> <span class="operator">=</span> <span class="word">Light</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">id</span> <span class="operator">=&gt;</span> <span class="core">shift</span> <span class="structure">);</span><br /><span class="word">print</span> <span class="symbol">$light</span><span class="operator">-&gt;</span><span class="word">name</span><span class="operator">,</span> <span class="single">' light is '</span><span class="structure">;</span><br /><span class="word">say</span> <span class="symbol">$light</span><span class="operator">-&gt;</span><span class="word">on</span> <span class="operator">?</span> <span class="single">'on'</span> <span class="operator">:</span> <span class="single">'off'</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>So if we happen to know the ID of the light we want to talk to, we can now find out if it&#39;s on or not:</p>

<pre><code>    $ ./status 1
    Left office is on</code></pre>

<h3 id="More-than-one-at-a-time">More than one at a time?</h3>

<p>Of course, I don&#39;t tend to memorize the IDs of all the light bulbs in my house. It&#39;d be much nicer to use the friendly name that we&#39;ve assigned to the bulb. It&#39;d also be great to pull down all the information for all the bulbs in one go rather than making an individual API call for each.</p>

<p>The Hue Bridge supports this by performing a simple GET request without the id as part of the URL:</p>

<pre><code>    curl http://192.168.1.2/api/xyZnl1BwQryLMNhJ3uNxUxnl7eQIwwqrkd5Kt0dd/lights
    {
    &quot;2&quot; : { ... },
    &quot;4&quot; : { ... },
    &quot;15&quot; : { ... },
    &quot;6&quot; : { ... },
    ...
    }</code></pre>

<p>Each of the keys in this top level object is the id of the light, and each of the values is the exact same JSON data structure that we would have received had we made an individual HTTP call per id.</p>

<p>Let&#39;s create a <i>Factory</i> class that can use this API call to make multiple Light objects at once.</p>

<p>First up, the generic Role again:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Role::Factory</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moo::Role</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Bridge</span><span class="structure">;</span><br /><br /><span class="comment"># we need to know both the URL endpoint *and* the<br /># name of the class we're constructing<br /></span><span class="word">requires</span> <span class="single">'endpoint'</span><span class="operator">,</span> <span class="single">'item_class'</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="word">bridge</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">Bridge</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">()</span> <span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="word">has</span> <span class="word">_data</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">clearer</span> <span class="operator">=&gt;</span> <span class="single">'flush_cache'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">default</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="prototype">($self)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">bridge</span><span class="operator">-&gt;</span><span class="word">get</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">endpoint</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="keyword">sub</span> <span class="word">items</span> <span class="prototype">($self)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_data_to_items</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_data</span> <span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">_data_to_items</span><span class="prototype">( $self, $data )</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">map</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">item_class</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">bridge</span> <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">bridge</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_data</span> <span class="operator">=&gt;</span> <span class="symbol">$data</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="magic">$_</span><span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">id</span> <span class="operator">=&gt;</span> <span class="magic">$_</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span> <span class="word">keys</span> <span class="cast">%</span><span class="structure">{</span> <span class="symbol">$data</span> <span class="structure">};</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Note how we&#39;re passing the <code>_data</code> into the Light classes. Since we&#39;re directly populating those attributes the objects never have to lazily call their <code>default</code> callbacks and don&#39;t have to make individual HTTP calls to populate themselves. Neat.</p>

<p>The LightFactory class is tiny:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">LightFactory</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moo</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">experimental</span> <span class="single">'signatures'</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Light</span><span class="structure">;</span><br /><br /><span class="word">with</span> <span class="single">'Role::Factory'</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">endpoint</span> <span class="structure">{</span> <span class="single">'/lights'</span> <span class="structure">}</span><br /><span class="keyword">sub</span> <span class="word">item_class</span> <span class="structure">{</span> <span class="single">'Light'</span> <span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>We can now trivially write a script to show the status of all lights in the house:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">LightFactory</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$lf</span> <span class="operator">=</span> <span class="word">LightFactory</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">;</span><br /><span class="keyword">foreach</span> <span class="structure">(</span><span class="symbol">$lf</span><span class="operator">-&gt;</span><span class="word">items</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">name</span> <span class="operator">.</span> <span class="single">' light is '</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">say</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">on</span> <span class="operator">?</span> <span class="single">'on'</span> <span class="operator">:</span> <span class="single">'off'</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Which prints out some useful information:</p>

<pre><code>    Bottom Studio downlight light is on
    Center Front Room light is on
    Elder&#39;s Overhead 1 light is on
    Elder&#39;s Overhead 2 light is on
    Elder&#39;s&rsquo;s Closet light is off
    Left Front Room light is on
    Left Studio Rooflight light is on
    Left office light is on
    Library by Computer light is on
    Main door left light is on
    Main door right light is on
    Middle downlight studio light is on
    Right office light is on
    Right studio Rooflight light is on
    South light is off
    Top Downlight Studio light is on
    Upstairs Studio light is on
    West light is on
    Younger&#39;s Closet light is off
    Younger&#39;s overhead 1 light is on
    Younger&#39;s overhead 2 light is on</code></pre>

<p>Hmm. I need to turn some lights off.</p>

<h3 id="Turning-the-lights-off">Turning the lights off</h3>

<p>Reading information about lights is all very well, but we want more control than that.</p>

<p>If we look at our light data structure we can see the <code>state</code> key are some values we&#39;d like to change:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="symbol">$VAR1</span> <span class="operator">=</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">...</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'state'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'reachable'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'mode'</span> <span class="operator">=&gt;</span> <span class="single">'homeautomation'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'bri'</span> <span class="operator">=&gt;</span> <span class="number">254</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'alert'</span> <span class="operator">=&gt;</span> <span class="single">'lselect'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'on'</span> <span class="operator">=&gt;</span> <span class="word">bless</span><span class="structure">(</span> <span class="word">do</span><span class="structure">{</span><span class="cast">\</span><span class="structure">(</span><span class="keyword">my</span> <span class="symbol">$o</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">)}</span><span class="operator">,</span> <span class="single">'JSON::PP::Boolean'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">...</span></code><br />&nbsp;</td></table>

<p>Specifically we&#39;d like to change the <code>on</code> value to false.</p>

<p>Making changes with the Hue Bridge is easy - you just have to PUT data instead of GETing it.</p>

<pre><code>    curl -X PUT \
         -d &#39;{&quot;on&quot;:false} \
         http://192.168.1.2/api/xyznl1BwQryLMOhJ3uNPUxnR7eQIwwqrkd5Kt0dd/lights/1/state</code></pre>

<p>There&#39;s two notable things about this curl command. Firstly, note the <code>/state</code> at the end of the URL, meaning we&#39;re changing the <code>state</code> key <i>within</i> the <code>lights/1</code> object. Secondly, note that we&#39;re not specifying all the keys in the JSON we&#39;re putting to this URL - any key we don&#39;t mention will be unchanged.</p>

<p>So, we want to do this from Perl space. Let&#39;s add a <code>put</code> method to our Bridge class:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">put</span> <span class="prototype">($self, $fragment, $data)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$url</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_url</span><span class="structure">(</span><span class="symbol">$fragment</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$tiny</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">http_tiny</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$tiny</span><span class="operator">-&gt;</span><span class="word">request</span><span class="structure">(</span><span class="single">'PUT'</span><span class="operator">,</span> <span class="symbol">$url</span><span class="operator">,</span> <span class="structure">{</span> <span class="word">content</span> <span class="operator">=&gt;</span> <span class="word">encode_json</span><span class="structure">(</span><span class="symbol">$data</span><span class="structure">)</span> <span class="structure">});</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>And then to the Lights class add a <code>_set_state</code> method that will take a hashref of new state options</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">_set_state</span><span class="prototype">( $self, $new_state )</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">bridge</span><span class="operator">-&gt;</span><span class="word">put</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">join</span> <span class="structure">(</span><span class="single">'/'</span><span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">endpoint</span><span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">id</span><span class="operator">,</span><span class="single">'state'</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$new_state</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now we can write some quick wrappers to turn lights on and off easily:</p>

<pre><code>    sub turn ($self, $new) {
        my $value = defined($new) &amp;&amp; $new &amp;&amp; $new !~ /^off$/i ?
            JSON::PP::true : JSON::PP::false;
        $self-&gt;_set_state({ on =&gt; $value } );
    }
    sub turn_on($self)  { $self-&gt;turn(&#39;on&#39;)  };
    sub turn_off($self) { $self-&gt;turn(&#39;off&#39;) };</code></pre>

<p>Let&#39;s save some electricity!</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">turn_off</span> <span class="word">foreach</span> <span class="word">LightFactory</span><span class="operator">-&gt;</span><span class="word">new-items</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<h3 id="Christmas-Lights">Christmas Lights</h3>

<p>On and off is all very good, but these lights are more capible than that. They can be set to arbitary brightness levels, and the more advanced ones can be set to any color.</p>

<p>Since it&#39;s Christmas, let&#39;s use this ability to make some christmas lights.</p>

<p>In order to set the color of the lights we&#39;re going to need to work out the hue, saturation, and lightness rating for the colors we want to use. To do this we&#39;re going to use the <a href="https://metacpan.org/module/Convert::Color">Convert::Color</a> module from the CPAN, specifically by creating a <a href="https://metacpan.org/module/Convert::Color::VGA">Convert::Color::VGA</a> instance from the name of the color we want to use and then converting it into an <a href="https://metacpan.org/module/Convert::Color::HSL">Convert::Color::HSL</a> instance.</p>

<p>Let&#39;s wrap that up in a handy method inside the Light class:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">set_color</span><span class="prototype">($self, $color_name)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$hsl</span> <span class="operator">=</span> <span class="word">Convert::Color::VGA</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="symbol">$color_name</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">convert_to</span><span class="structure">(</span><span class="single">'hsl'</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">_set_state</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">hue</span> <span class="operator">=&gt;</span> <span class="word">int</span><span class="structure">(</span> <span class="symbol">$hsl</span><span class="operator">-&gt;</span><span class="word">hue</span><span class="operator">/</span><span class="number">360</span><span class="operator">*</span><span class="number">65535</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sat</span> <span class="operator">=&gt;</span> <span class="word">int</span><span class="structure">(</span> <span class="symbol">$hsl</span><span class="operator">-&gt;</span><span class="word">saturation</span><span class="operator">*</span><span class="number">254</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">bri</span> <span class="operator">=&gt;</span> <span class="word">int</span><span class="structure">(</span> <span class="symbol">$hsl</span><span class="operator">-&gt;</span><span class="word">lightness</span><span class="operator">*</span><span class="number">254</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">})</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now we can finally write a simple script to get the lights to change in a Christmassy way:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!/usr/bin/perl<br /></span><br /><span class="keyword">use</span> <span class="float">5.024</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">LightFactory</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">%all_lights</span> <span class="operator">=</span> <span class="word">map</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">name</span> <span class="operator">=&gt;</span> <span class="magic">$_</span><br /><span class="structure">}</span> <span class="word">LightFactory</span><span class="operator">-&gt;</span><span class="word">new</span><span class="operator">-&gt;</span><span class="word">items</span><span class="structure">;</span><br /><br /><span class="comment"># I really should have done a more consistent job of naming these<br /></span><span class="keyword">my</span> <span class="symbol">@lights</span> <span class="operator">=</span> <span class="symbol">@all_lights</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Bottom Studio downlight&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Middle downlight studio&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Top Downlight Studio&quot;</span><span class="operator">,</span><br /><span class="structure">};</span><br /><br /><span class="keyword">while</span> <span class="structure">(</span><span class="number">1</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$lights</span><span class="structure">[</span><span class="number">0</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">set_color</span><span class="structure">(</span><span class="single">'red'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$lights</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">set_color</span><span class="structure">(</span><span class="single">'green'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$lights</span><span class="structure">[</span><span class="number">2</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">set_color</span><span class="structure">(</span><span class="single">'red'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sleep</span> <span class="number">1</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$lights</span><span class="structure">[</span><span class="number">0</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">set_color</span><span class="structure">(</span><span class="single">'green'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$lights</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">set_color</span><span class="structure">(</span><span class="single">'red'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$lights</span><span class="structure">[</span><span class="number">2</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">set_color</span><span class="structure">(</span><span class="single">'green'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">sleep</span> <span class="number">1</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Going for Perl" href="2019-12-04.html">Previous</a></li>

    <li class="next"><a title="The Weather Outside Is Frightful" href="2019-12-06.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





